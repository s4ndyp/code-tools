<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Snippet Matcher & Replacer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ace.js"></script>
    <!-- JS Beautify voor het netjes maken van de code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-css.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .highlight-match {
            background-color: rgba(59, 130, 246, 0.25) !important;
            border-left: 4px solid #3b82f6;
            position: absolute;
            z-index: 20;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ace_gutter {
            background: #1e293b !important;
            color: #64748b !important;
        }

        /* Toggle Switch Style */
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-14 flex items-center justify-between px-6 border-b border-slate-800 glass-panel shrink-0">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
            <h1 class="text-lg font-semibold tracking-tight">Code <span class="text-blue-500">Match & Swap</span></h1>
        </div>
        <div class="flex gap-2">
            <button id="formatBtn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 border border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-2"/><path d="M21 12H3"/><path d="M9 17l-3-5 3-5"/><path d="M15 17l3-5-3-5"/></svg>
                Formatteer
            </button>
            <button id="findBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 shadow-lg shadow-blue-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                Zoek Match
            </button>
            <button id="replaceBtn" disabled class="bg-emerald-600 hover:bg-emerald-500 disabled:opacity-30 disabled:cursor-not-allowed text-white px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2 shadow-lg shadow-emerald-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7l5 5-5 5"/><path d="M13 7l5 5-5 5"/></svg>
                Vervang
            </button>
            <button id="undoBtn" disabled class="bg-slate-700 hover:bg-slate-600 disabled:opacity-30 disabled:cursor-not-allowed text-white px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                Herstel
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Column: Source Code -->
        <div class="flex-1 flex flex-col border-r border-slate-800 p-4 min-w-0">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-500">Hoofdbestand (Source)</span>
                    <span id="detectedLang" class="bg-slate-800 text-blue-400 text-[10px] px-2 py-0.5 rounded border border-slate-700">Detecteren...</span>
                </div>
                <span id="lineCount" class="text-xs text-slate-500"></span>
            </div>
            <div id="sourceEditorContainer" class="flex-1 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden relative shadow-inner">
                <textarea id="sourceEditor" class="hidden"></textarea>
            </div>
        </div>

        <!-- Right Column: Snippet & Settings -->
        <div class="w-1/3 flex flex-col p-4 bg-slate-900/30 shrink-0">
            
            <!-- Snippet Input -->
            <div class="flex-1 flex flex-col mb-4 min-h-0">
                <div class="flex items-center justify-between mb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">
                    <span>Nieuwe Snippet</span>
                </div>
                <div id="snippetEditorContainer" class="flex-1 bg-slate-950 rounded-lg border border-slate-800 overflow-hidden shadow-inner">
                    <textarea id="snippetEditor" class="hidden"></textarea>
                </div>
            </div>

            <!-- Settings & Match Info -->
            <div class="flex flex-col gap-3 shrink-0">
                
                <!-- Options Panel -->
                <div class="glass-panel rounded-lg p-4 border border-slate-800 flex flex-col gap-3">
                    <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-widest mb-1">Zoekinstellingen</h3>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-slate-300 flex items-center gap-2">
                            Negeer witruimte & comments
                        </label>
                        <label class="switch">
                            <input type="checkbox" id="flexibleMatchToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Match Result Info -->
                <div class="h-44 glass-panel rounded-lg p-5 border border-slate-800 flex flex-col gap-3 overflow-y-auto shadow-xl">
                    <h3 class="text-sm font-semibold text-slate-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        Match Informatie
                    </h3>
                    
                    <div id="matchDetails" class="text-sm text-slate-400 leading-relaxed">
                        Geen actieve match.
                    </div>

                    <div id="similarityScore" class="mt-auto pt-3 border-t border-slate-800 hidden">
                        <div class="flex justify-between text-xs font-medium mb-2">
                            <span class="text-slate-500">Match score:</span>
                            <span id="scoreVal" class="text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                            <div id="scoreBar" class="bg-blue-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification system -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 border border-slate-700 px-5 py-3 rounded-xl shadow-2xl text-sm transform translate-y-32 transition-transform duration-300 flex items-center gap-3 z-50">
        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
        <span id="toastMsg">Bestand bijgewerkt!</span>
    </div>

    <!-- Scripts -->
    <script>
        let sourceEditor, snippetEditor;
        let lastMatch = null;
        let backupSourceContent = null;
        let currentMode = "javascript";

        window.onload = () => {
            // Setup Editors
            sourceEditor = ace.edit("sourceEditorContainer");
            sourceEditor.setTheme("ace/theme/tomorrow_night_eighties");
            sourceEditor.session.setMode("ace/mode/javascript");
            sourceEditor.setOptions({
                fontSize: "13px",
                fontFamily: "Fira Code",
                showPrintMargin: false,
                useSoftTabs: true,
                tabSize: 2,
                wrap: true
            });

            snippetEditor = ace.edit("snippetEditorContainer");
            snippetEditor.setTheme("ace/theme/tomorrow_night_eighties");
            snippetEditor.session.setMode("ace/mode/javascript");
            snippetEditor.setOptions({
                fontSize: "13px",
                fontFamily: "Fira Code",
                showPrintMargin: false,
                highlightActiveLine: false,
                showGutter: true,
                wrap: true
            });

            // Demo content
            sourceEditor.setValue(`// Database Connector v1.2\nfunction connect() {\n    /* \n       TODO: Add SSL support \n    */\n    const connection = {\n        db: "postgres",\n        port: 5432\n    };\n    \n    console.log("Connected to " + connection.db);\n    return connection;\n}\n\nconnect();`, -1);

            snippetEditor.setValue(`function connect() {\n    const connection = {\n        db: "mysql",\n        port: 3306,\n        ssl: true\n    };\n    return connection;\n}`, -1);
            
            updateLineCount();
            detectLanguage();

            sourceEditor.on("change", () => {
                updateLineCount();
                detectLanguage();
            });
        };

        // Option 5: Auto Syntax Detectie
        function detectLanguage() {
            const code = sourceEditor.getValue().substring(0, 1000); // Check eerste 1000 tekens
            let detected = "javascript";
            
            if (code.includes("<!DOCTYPE html>") || (code.includes("<html") && code.includes("</html>"))) {
                detected = "html";
            } else if (code.includes("def ") || code.includes("import ") && code.includes("print(")) {
                detected = "python";
            } else if (code.includes("{") && code.includes(":") && (code.includes("margin:") || code.includes("color:"))) {
                detected = "css";
            }

            if (detected !== currentMode) {
                currentMode = detected;
                sourceEditor.session.setMode("ace/mode/" + detected);
                snippetEditor.session.setMode("ace/mode/" + detected);
                document.getElementById('detectedLang').innerText = detected.toUpperCase();
            }
        }

        function updateLineCount() {
            const count = sourceEditor.session.getLength();
            document.getElementById('lineCount').innerText = `${count} regels`;
        }

        // Option 7: Flexible Normalization (Negeer whitespace & comments)
        function normalizeCode(str, flexible = true) {
            if (!flexible) return str.toLowerCase();
            
            // Verwijder single-line comments //
            let processed = str.replace(/\/\/.*$/gm, '');
            // Verwijder multi-line comments /* */
            processed = processed.replace(/\/\*[\s\S]*?\*\//g, '');
            // Verwijder HTML comments <!-- -->
            processed = processed.replace(/<!--[\s\S]*?-->/g, '');
            // Verwijder alle witruimte
            processed = processed.replace(/\s+/g, '');
            
            return processed.toLowerCase();
        }

        function calculateSimilarity(s1, s2) {
            let longer = s1.length >= s2.length ? s1 : s2;
            let shorter = s1.length < s2.length ? s1 : s2;
            if (longer.length === 0) return 1.0;
            return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
        }

        function editDistance(s1, s2) {
            let costs = new Array();
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i == 0) costs[j] = j;
                    else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function findBestMatch() {
            const source = sourceEditor.getValue();
            const snippet = snippetEditor.getValue();
            const isFlexible = document.getElementById('flexibleMatchToggle').checked;

            if (!source.trim() || !snippet.trim()) {
                showToast("Vul eerst code en een snippet in.");
                return;
            }

            const sourceLines = source.split('\n');
            const snippetLines = snippet.split('\n');
            const snippetLen = snippetLines.length;

            let bestScore = -1;
            let bestIndex = -1;
            let bestMatchLineCount = snippetLen;

            const normalizedSnippet = normalizeCode(snippet, isFlexible);

            for (let i = 0; i <= sourceLines.length - 1; i++) {
                for (let offset = -4; offset <= 4; offset++) {
                    let currentLen = snippetLen + offset;
                    if (currentLen < 1) continue;
                    
                    let endIdx = Math.min(i + currentLen, sourceLines.length);
                    let currentBlock = sourceLines.slice(i, endIdx).join('\n');
                    let normalizedBlock = normalizeCode(currentBlock, isFlexible);

                    let score = calculateSimilarity(normalizedSnippet, normalizedBlock);
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestIndex = i;
                        bestMatchLineCount = endIdx - i;
                        if (score === 1) break;
                    }
                }
                if (bestScore === 1) break;
            }

            if (bestIndex !== -1 && bestScore > 0.1) {
                highlightMatch(bestIndex, bestMatchLineCount, bestScore);
            } else {
                showToast("Geen vergelijkbare code gevonden.");
                document.getElementById('replaceBtn').disabled = true;
            }
        }

        function highlightMatch(startIndex, lineCount, score) {
            const session = sourceEditor.getSession();
            const markers = session.getMarkers();
            for (let m in markers) {
                if (markers[m].type === "background") session.removeMarker(markers[m].id);
            }

            const Range = ace.require("ace/range").Range;
            const matchRange = new Range(startIndex, 0, startIndex + lineCount - 1, 1000);
            
            session.addMarker(matchRange, "highlight-match", "background");
            sourceEditor.scrollToLine(startIndex, true, true, () => {});

            lastMatch = { start: startIndex, end: startIndex + lineCount - 1, range: matchRange };
            
            const scorePercent = Math.round(score * 100);
            document.getElementById('matchDetails').innerHTML = `
                Match op regel <strong>${startIndex + 1}</strong>.<br>
                Status: <strong>${scorePercent}% vergelijkbaar</strong>.
            `;
            
            document.getElementById('similarityScore').classList.remove('hidden');
            document.getElementById('scoreVal').innerText = scorePercent + '%';
            document.getElementById('scoreBar').style.width = scorePercent + '%';
            
            document.getElementById('replaceBtn').disabled = false;
        }

        function replaceSnippet() {
            if (!lastMatch) return;
            backupSourceContent = sourceEditor.getValue();
            const snippet = snippetEditor.getValue();
            sourceEditor.getSession().replace(lastMatch.range, snippet);
            showToast("Code vervangen en herschikt!");
            document.getElementById('replaceBtn').disabled = true;
            document.getElementById('undoBtn').disabled = false;
            document.getElementById('similarityScore').classList.add('hidden');
            const markers = sourceEditor.getSession().getMarkers();
            for (let m in markers) sourceEditor.getSession().removeMarker(markers[m].id);
            lastMatch = null;
        }

        // Nieuwe functie: Formatteer Code (Beautify)
        function formatCode() {
            const content = sourceEditor.getValue();
            let formatted = content;
            const options = { indent_size: 2, space_in_empty_paren: true };

            try {
                if (currentMode === "javascript") {
                    formatted = js_beautify(content, options);
                } else if (currentMode === "html") {
                    formatted = html_beautify(content, options);
                } else if (currentMode === "css") {
                    formatted = css_beautify(content, options);
                }
                
                if (formatted !== content) {
                    backupSourceContent = content; // Zodat je format ook ongedaan kan maken
                    sourceEditor.setValue(formatted, -1);
                    document.getElementById('undoBtn').disabled = false;
                    showToast("Code geformatteerd!");
                }
            } catch (err) {
                showToast("Fout bij formatteren.");
            }
        }

        function undoReplacement() {
            if (backupSourceContent === null) return;
            sourceEditor.setValue(backupSourceContent, -1);
            backupSourceContent = null;
            document.getElementById('undoBtn').disabled = true;
            showToast("Herstel uitgevoerd.");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-32');
            setTimeout(() => toast.classList.add('translate-y-32'), 3000);
        }

        document.getElementById('findBtn').addEventListener('click', findBestMatch);
        document.getElementById('replaceBtn').addEventListener('click', replaceSnippet);
        document.getElementById('undoBtn').addEventListener('click', undoReplacement);
        document.getElementById('formatBtn').addEventListener('click', formatCode);
    </script>
</body>
</html>
