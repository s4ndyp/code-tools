<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 950: '#020617' } } } }
        }
    </script>
    <style>
        /* Standaard scrollbar  stijlen */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; }
        .code-font { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
        
        /* Zorg dat de CodeMirror editor de ruimte vult */
        /* CodeMirror 5 Stijlen */
        .CodeMirror {
            height: 100%; 
            width: 100%;
            border: 1px solid #334155; 
            border-radius: 0.25rem; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 16px;
            background-color: #1e293b; 
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1); 
        }
        
        /* CodeMirror focus stijl */
        .CodeMirror-focused {
            border-color: #3b82f6 !important; 
            outline: none;
        }

        /* Stijl voor de scrollbar van de editor (als deze niet via webkit-scrollbar gaat) */
        .CodeMirror-vscrollbar, .CodeMirror-hscrollbar {
            background-color: #0f172a;
        }

        /* Visuele feedback voor favorieten */
        .favorite-btn:hover {
            color: #f59e0b; 
        }
        .is-favorite svg {
            fill: #f59e0b; 
            stroke: #f59e0b;
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>

</head>
<body class="bg-slate-900 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="h-14 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4 shadow-md z-20">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-400 hover:text-white flex items-center gap-1 text-sm font-medium transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Home
            </a>
            <div class="h-6 w-px bg-slate-600 mx-2"></div>
            <h1 class="text-lg font-bold tracking-wide">HTML <span class="text-blue-500">Playground</span></h1>
        </div>
        <div>
            <button id="btn-back" onclick="toggleMode('editor')" class="hidden flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white text-sm px-3 py-1.5 rounded transition-colors">
                Terug naar Editor
            </button>
        </div>
    </header>

    <main class="flex flex-1 relative overflow-hidden">
        
        <div id="editor-container" class="flex w-full h-full">
            <div class="flex-1 flex flex-col p-4 gap-4 h-full relative">
                
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700">
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-xs sm:text-sm px-3 py-2 rounded flex items-center gap-2 transition text-slate-300 hover:text-white">
                            <span>Upload</span>
                            <input type="file" accept=".html,.htm,.txt" class="hidden" onchange="handleFileUpload(this)">
                        </label>
                        <button onclick="clearEditor()" class="text-slate-400 hover:text-red-400 text-xs sm:text-sm px-3 py-2 transition">Wissen</button>
                        <span id="line-count" class="text-sm text-slate-400 flex items-center pl-2">Regels: 0</span>
                    </div>
                    <button onclick="runCode()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-1.5 rounded font-bold shadow-lg shadow-blue-900/50 flex items-center gap-2 transition transform hover:scale-105 text-sm">
                        RUN
                    </button>
                </div>

                <div class="flex gap-2 items-center">
                    <input type="text" id="search-input" placeholder="Zoekterm..." class="flex-1 p-2 bg-slate-700 text-slate-200 rounded border border-slate-600 focus:outline-none focus:border-blue-500 text-sm">
                    <button onclick="startSearch()" class="flex-shrink-0 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded font-medium transition text-sm">
                        Zoek
                    </button>
                    <button id="next-match-btn" onclick="goToNextMatch()" class="flex-shrink-0 bg-blue-600 hover:bg-blue-500 text-white p-2 rounded font-medium transition text-sm disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <textarea id="code-textarea" placeholder="Plaats hier uw volledige HTML-code." class="hidden">
                    </textarea>
                <div id="code-editor-wrapper" class="flex-1 w-full relative">
                    </div>
            </div>
            
            <div class="w-72 bg-slate-800 border-l border-slate-700 flex flex-col hidden md:flex">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold text-slate-300 text-sm">Geschiedenis</h2>
                    <button onclick="clearHistory()" class="text-xs text-slate-500 hover:text-red-400">Wis (niet-favorieten)</button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>
        </div>

        <div id="preview-container" class="hidden w-full h-full bg-white">
            <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
        </div>
    </main>

    <script>
        const editorContainer = document.getElementById('editor-container');
        const previewContainer = document.getElementById('preview-container');
        const previewFrame = document.getElementById('preview-frame');
        const btnBack = document.getElementById('btn-back');
        const historyListEl = document.getElementById('history-list');
        const searchInput = document.getElementById('search-input');
        const nextMatchBtn = document.getElementById('next-match-btn');
        const codeTextArea = document.getElementById('code-textarea'); 
        const lineCountEl = document.getElementById('line-count'); // NIEUW ELEMENT

        let history = [];
        let searchMatches = [];
        let currentMatchIndex = -1;
        let lastSearchTerm = '';
        let cmEditor; 

        // Functie om het aantal regels in de UI te updaten
        function updateLineCount() {
            if (cmEditor) {
                const count = cmEditor.lineCount();
                lineCountEl.textContent = `Regels: ${count}`;
            }
        }

        // --- CodeMirror 5 Initialisatie ---
        function initializeCodeMirror() {
            cmEditor = CodeMirror.fromTextArea(codeTextArea, {
                mode: 'htmlmixed',
                theme: 'dracula', 
                lineNumbers: true, 
                lineWrapping: true, 
                styleActiveLine: true, 
                autofocus: true,
                viewportMargin: Infinity 
            });

            const cmElement = cmEditor.getWrapperElement();
            cmElement.classList.add('flex-1'); 
            document.getElementById('code-editor-wrapper').appendChild(cmElement);
            
            cmEditor.focus();
            updateLineCount(); // Eerste telling

            // Luister naar veranderingen in de CodeMirror editor
            cmEditor.on('change', updateLineCount);
        }
        
        window.addEventListener('DOMContentLoaded', initializeCodeMirror);

        // CodeMirror Abstraction
        const codeInput = {
            getValue: () => cmEditor ? cmEditor.getValue() : codeTextArea.value,
            setValue: (value) => {
                if (cmEditor) {
                    cmEditor.setValue(value);
                    updateLineCount(); // Update de telling na het instellen van een nieuwe waarde
                } else {
                    codeTextArea.value = value;
                }
            },
            focus: () => cmEditor ? cmEditor.focus() : codeTextArea.focus(),
            setSelectionRange: (start, end) => {
                if (cmEditor) {
                    const from = cmEditor.posFromIndex(start);
                    const to = cmEditor.posFromIndex(end);
                    cmEditor.setSelection(from, to);
                }
            },
            scrollIntoView: (start, end) => {
                if (cmEditor) {
                    const from = cmEditor.posFromIndex(start);
                    const to = cmEditor.posFromIndex(end);
                    cmEditor.scrollIntoView({ from: from, to: to });
                }
            },
            getLineCount: () => cmEditor ? cmEditor.lineCount() : 0 // NIEUWE HULPFUNCTIE
        };
        // --- Einde CodeMirror Initialisatie ---


        function toggleMode(mode) {
            if (mode === 'preview') {
                editorContainer.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                btnBack.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
                editorContainer.classList.remove('hidden');
                btnBack.classList.add('hidden');
                previewFrame.srcdoc = ''; 
                codeInput.focus(); 
            }
        }

        function runCode() {
            const code = codeInput.getValue(); 
            if (!code.trim()) { 
                console.error("Voer eerst HTML in!"); 
                return; 
            }
            addToHistory(code);
            previewFrame.srcdoc = code;
            toggleMode('preview');
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    codeInput.setValue(e.target.result); 
                    resetSearch();
                };
                reader.readAsText(input.files[0]);
            }
        }

        function clearEditor() {
            console.log('Editor is leeggemaakt.');
            codeInput.setValue(''); 
            resetSearch(); 
        }

        // NIEUWE FUNCTIE: Reset de zoektoestand
        function resetSearch() {
            searchMatches = [];
            currentMatchIndex = -1;
            lastSearchTerm = '';
            nextMatchBtn.disabled = true;
            codeInput.setSelectionRange(0, 0); 
        }

        // AANGEPASTE FUNCTIE: Start of vervolgt de zoekopdracht met CodeMirror 5 API
        function startSearch() {
            if (!cmEditor) return;
            const searchTerm = searchInput.value;
            const code = codeInput.getValue();

            if (!searchTerm) {
                resetSearch();
                searchInput.focus();
                return;
            }

            if (searchTerm.toLowerCase() !== lastSearchTerm.toLowerCase()) {
                lastSearchTerm = searchTerm;
                searchMatches = [];
                currentMatchIndex = -1;

                let cursor = cmEditor.getSearchCursor(searchTerm, { line: 0, ch: 0 }, false); 
                while (cursor.findNext()) {
                    const fromIndex = cmEditor.indexFromPos(cursor.from());
                    const toIndex = cmEditor.indexFromPos(cursor.to());
                    searchMatches.push({ start: fromIndex, end: toIndex });
                }

                if (searchMatches.length === 0) {
                    console.log(`Zoekterm "${searchTerm}" niet gevonden.`);
                    resetSearch();
                    return;
                }
            }
            
            goToNextMatch();

            nextMatchBtn.disabled = searchMatches.length <= 1;
        }

        // AANGEPASTE FUNCTIE: Gaat naar de volgende gevonden tekst met CodeMirror 5 API
        function goToNextMatch() {
            if (searchMatches.length === 0) return;

            currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
            
            const match = searchMatches[currentMatchIndex];
            
            codeInput.setSelectionRange(match.start, match.end);
            codeInput.scrollIntoView(match.start, match.end); 

            codeInput.focus();
            console.log(`Match ${currentMatchIndex + 1} van ${searchMatches.length} geselecteerd.`);
        }

        // --- Geschiedenis Functies (AANGEPAST) ---

        function saveHistory() {
            localStorage.setItem('htmlTesterHistory', JSON.stringify(history));
        }

        function loadHistory() {
            const stored = localStorage.getItem('htmlTesterHistory');
            if (stored) {
                history = JSON.parse(stored).map(item => ({
                    ...item,
                    isFavorite: item.isFavorite || false,
                    lineCount: item.lineCount || 0 // Zorg dat lineCount bestaat
                }));
            }
            renderHistory();
        }

        function getLineCountOfCode(code) {
             // Telt het aantal \n karakters + 1 (voor de laatste regel)
            return (code.match(/\n/g) || []).length + (code.trim() !== '' ? 1 : 0);
        }

        function addToHistory(code) {
            if (history.length > 0 && history[0].code === code) return; 

            const newItem = {
                code: code,
                timestamp: new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }),
                preview: code.replace(/<[^>]*>?/gm, '').substring(0, 30) || "Code snippet",
                isFavorite: false,
                lineCount: getLineCountOfCode(code) // NIEUWE WAARDE: Aantal regels
            };

            history.unshift(newItem);

            while (history.length > 10) {
                const lastIndex = history.length - 1;
                if (!history[lastIndex].isFavorite) {
                    history.pop();
                } else {
                    break; 
                }
            }

            saveHistory();
            renderHistory();
        }

        function clearHistory() {
            const favorites = history.filter(item => item.isFavorite);
            history = favorites; 
            saveHistory();
            renderHistory();
            if (favorites.length === 0) {
                console.log('Geschiedenis is volledig gewist.');
            } else {
                console.log(`Niet-favoriete geschiedenis is gewist. ${favorites.length} favorieten zijn behouden.`);
            }
        }
        
        function toggleFavorite(index, event) {
            event.stopPropagation(); 
            history[index].isFavorite = !history[index].isFavorite;
            saveHistory();
            renderHistory(); 
        }

        // AANGEPAST om lineCount in de weergave op te nemen
        function renderHistory() {
            historyListEl.innerHTML = '';
            if (history.length === 0) {
                historyListEl.innerHTML = '<p class="text-slate-500 text-xs text-center mt-6 italic">Geen geschiedenis.</p>';
                return;
            }
            
            history.forEach((item, index) => {
                const div = document.createElement('div');
                const favoriteClass = item.isFavorite ? 'border-amber-500 ring-2 ring-amber-500/50' : 'border-transparent hover:border-slate-500';

                div.className = `bg-slate-700 hover:bg-slate-600 p-2 rounded cursor-pointer transition relative ${favoriteClass}`;
                
                div.onclick = () => { codeInput.setValue(item.code); resetSearch(); }; 
                
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold ${item.isFavorite ? 'text-amber-400' : 'text-blue-400'}">#${history.length - index}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400">${item.timestamp}</span>
                            <span class="text-[10px] text-slate-400 font-mono">Lijnen: ${item.lineCount}</span> <button 
                                class="favorite-btn ${item.isFavorite ? 'is-favorite' : 'text-slate-500 hover:text-amber-500'}"
                                onclick="toggleFavorite(${index}, event)"
                                title="${item.isFavorite ? 'Favoriet uitschakelen' : 'Toevoegen aan favorieten'}"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="text-xs text-slate-300 font-mono truncate">${item.preview}</div>
                `;
                historyListEl.appendChild(div);
            });
        }
        
        loadHistory();
    </script>
</body>
</html>
