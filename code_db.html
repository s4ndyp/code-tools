<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Versiebeheer - Project Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: '#0f172a', dark_paper: '#1e293b', dark_border: '#334155',
                        primary: '#6366f1', primary_hover: '#4f46e5', success: '#22c55e', danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        #editor { font-family: 'JetBrains Mono', monospace; width: 100%; height: 100%; }
        .ace_editor { background-color: #0f172a !important; color: #e2e8f0 !important; }
        .ace_gutter { background-color: #1e293b !important; color: #64748b !important; border-right: 1px solid #334155 !important; }
        .ace_cursor { color: #6366f1 !important; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Drag Overlay */
        #drag-overlay { pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        #drag-overlay.active { opacity: 1; pointer-events: all; }
        
        /* Custom tree lines for the sidebar structure */
        .tree-indent { padding-left: 1rem; position: relative; }
        .tree-indent:before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0.25rem; 
            bottom: 0; 
            width: 1px; 
            background-color: #334155; 
        }
    </style>
</head>

<body class="flex h-screen w-screen relative" ondrop="return false;">

    <div id="drag-overlay" class="fixed inset-0 z-[100] bg-primary/20 backdrop-blur-sm border-4 border-dashed border-primary m-4 rounded-xl flex items-center justify-center">
        <div class="bg-dark_paper p-6 rounded-xl shadow-2xl flex flex-col items-center animate-bounce">
            <i data-lucide="upload-cloud" width="48" class="text-primary mb-2"></i>
            <h2 class="text-xl font-bold text-white">Bestand Loslaten</h2>
            <p class="text-slate-400">Sleep hier om te uploaden naar het actieve project</p>
        </div>
    </div>

    <aside class="flex flex-col w-72 h-full bg-dark_paper border-r border-dark_border flex-shrink-0 z-20 transition-all duration-300 relative" id="sidebar">
        <div class="p-4 border-b border-dark_border flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-primary to-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                <i data-lucide="git-branch" width="18"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm text-white">Code Repo</h1>
                <p class="text-[10px] text-slate-400">Versiebeheer</p>
            </div>
        </div>

        <div class="p-3 border-b border-dark_border bg-dark_paper space-y-2">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-500" width="14"></i>
                <input type="text" id="search-input" placeholder="Zoeken in projecten..." class="w-full bg-dark border border-dark_border text-slate-300 text-xs rounded-md pl-9 pr-2 py-2 focus:outline-none focus:border-primary">
            </div>
            
            <div class="flex gap-2">
                <button onclick="window.saveNewProject()" class="w-1/4 bg-dark border border-dark_border hover:bg-slate-700 text-slate-400 hover:text-primary text-xs py-2 rounded transition-colors flex items-center justify-center" title="Nieuw Project">
                    <i data-lucide="folder-plus" width="14"></i>
                </button>
                <button onclick="window.createNewItem(false)" class="w-1/4 bg-dark border border-dark_border hover:bg-slate-700 text-slate-400 hover:text-primary text-xs py-2 rounded transition-colors flex items-center justify-center" title="Nieuw Bestand (in actieve map)">
                    <i data-lucide="file-plus-2" width="14"></i>
                </button>
                 <button onclick="window.createNewItem(true)" class="w-1/4 bg-dark border border-dark_border hover:bg-slate-700 text-slate-400 hover:text-primary text-xs py-2 rounded transition-colors flex items-center justify-center" title="Nieuwe Submap (in actieve map)">
                    <i data-lucide="folder-x" width="14"></i>
                </button>
                <button onclick="window.toggleEditMode()" id="edit-mode-btn" class="w-1/4 bg-dark border border-dark_border hover:bg-slate-700 text-slate-400 text-xs py-2 rounded transition-colors flex items-center justify-center" title="Beheer Modus">
                    <i data-lucide="settings-2" width="14"></i>
                </button>
            </div>
            <p id="active-container-info" class="text-[10px] text-slate-500 mt-1 pl-1 truncate">Actieve map: Project Root</p>
        </div>

        <div class="flex-1 overflow-y-auto p-2">
            <ul id="sidebar-list" class="space-y-1"></ul>
        </div>

        <div class="p-3 border-t border-dark_border text-[10px] text-slate-500 flex justify-between items-center bg-dark_paper">
            <span>Local Storage</span>
            <div class="flex gap-2">
                <button onclick="window.exportData()" class="hover:text-white" title="Export JSON (Alles)"><i data-lucide="download" width="12"></i></button>
                <button onclick="window.triggerImport()" class="hover:text-white" title="Import JSON"><i data-lucide="upload" width="12"></i></button>
            </div>
            <input type="file" id="importFile" accept=".json" class="hidden">
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-dark relative min-w-0">
        <div class="h-14 border-b border-dark_border bg-dark_paper flex items-center justify-between px-4 flex-shrink-0">
            <div class="flex items-center gap-2 overflow-hidden">
                <i data-lucide="file-code" class="text-primary flex-shrink-0" width="18"></i>
                <span id="editor-title-status" class="text-sm font-medium text-slate-200 truncate">Geen bestand geselecteerd</span>
            </div>
            
            <div class="flex items-center gap-2">
                <button id="btn-save-pending" onclick="window.commitPendingVersion()" class="hidden animate-pulse bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-green-900/20 flex items-center gap-2 mr-4 transition-all">
                    <i data-lucide="save" width="14"></i> WIJZIGINGEN OPSLAAN
                </button>

                <div id="action-group-normal" class="flex items-center gap-2">
                    <button onclick="window.toggleCodeSearch()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="Zoek in Code (Ctrl+F/Cmd+F)">
                        <i data-lucide="search" width="18"></i>
                    </button>
                    <div class="h-4 w-px bg-dark_border mx-1"></div>

                    <div class="flex bg-dark rounded-lg p-1 border border-dark_border">
                        <button onclick="window.initiateNewVersion('major')" class="p-1.5 hover:bg-slate-700 rounded text-green-400 transition-colors tooltip" title="Start nieuwe Major versie (Vraagt om omschrijving, leegt editor)">
                            <span class="text-xs font-bold px-1">Major++</span>
                        </button>
                        <div class="w-px bg-dark_border my-1"></div>
                        <button onclick="window.initiateNewVersion('minor')" class="p-1.5 hover:bg-slate-700 rounded text-blue-400 transition-colors tooltip" title="Start nieuwe Minor versie (Vraagt om omschrijving, leegt editor)">
                            <span class="text-xs font-bold px-1">Minor++</span>
                        </button>
                    </div>

                    <div class="h-4 w-px bg-dark_border mx-1"></div>
                    
                    <button onclick="window.downloadActiveFile()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="Download Huidig Bestand">
                        <i data-lucide="download" width="18"></i>
                    </button>

                    <div class="h-4 w-px bg-dark_border mx-1"></div>

                    <button onclick="window.copyCodeToClipboard()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="Kopieer">
                        <i data-lucide="copy" width="18"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="code-search-bar" class="hidden absolute top-14 left-0 right-0 h-10 bg-dark_paper border-b border-dark_border flex items-center px-4 z-10">
            <input type="text" id="code-search-input" placeholder="Zoek in code..." class="flex-1 bg-dark border border-dark_border text-slate-300 text-xs rounded-md px-3 py-1.5 focus:outline-none focus:border-primary">
            <button onclick="window.findNextInCode(true)" class="ml-2 p-1.5 bg-dark_border hover:bg-slate-700 text-slate-400 rounded transition-colors" title="Volgende resultaat">
                <i data-lucide="arrow-down" width="16"></i>
            </button>
             <button onclick="window.findNextInCode(false)" class="p-1.5 bg-dark_border hover:bg-slate-700 text-slate-400 rounded transition-colors" title="Vorig resultaat">
                <i data-lucide="arrow-up" width="16"></i>
            </button>
            <button onclick="window.closeCodeSearch()" class="ml-2 p-1.5 hover:text-red-400 text-slate-400 rounded transition-colors" title="Sluiten">
                <i data-lucide="x" width="16"></i>
            </button>
        </div>

        <div class="flex-1 relative">
            <div id="editor"></div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-2xl text-white text-sm font-medium flex items-center gap-3 backdrop-blur-md border border-white/10 opacity-0 pointer-events-none transition-all duration-300 z-50 translate-y-2"></div>

    <div id="upload-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-dark_paper border border-dark_border w-full max-w-sm rounded-xl shadow-2xl overflow-hidden fade-in">
            <div class="p-5">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-yellow-500/10 rounded-full flex items-center justify-center text-yellow-500">
                        <i data-lucide="file-warning" width="20"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Bestand Bestaat Al</h3>
                        <p class="text-xs text-slate-400">Hoe wil je '<span id="upload-filename"></span>' updaten?</p>
                    </div>
                </div>
                <p class="text-sm text-slate-300 mb-6">Er is een nieuwe versie gedetecteerd. Kies het type update.</p>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-upload-minor" class="bg-dark border border-dark_border hover:border-blue-500 hover:text-blue-400 text-slate-300 py-3 rounded-lg text-sm font-bold transition-all flex flex-col items-center">
                        <span class="uppercase text-[10px] text-slate-500 mb-1">Kleine Wijziging</span>
                        MINOR UPDATE
                    </button>
                    <button id="btn-upload-major" class="bg-dark border border-dark_border hover:border-green-500 hover:text-green-400 text-slate-300 py-3 rounded-lg text-sm font-bold transition-all flex flex-col items-center">
                        <span class="uppercase text-[10px] text-slate-500 mb-1">Grote Wijziging</span>
                        MAJOR UPDATE
                    </button>
                </div>
                <button onclick="document.getElementById('upload-modal').classList.add('hidden')" class="w-full mt-3 py-2 text-xs text-slate-500 hover:text-white">Annuleren</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-dark_paper border border-dark_border w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden fade-in flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-dark_border flex justify-between items-center bg-dark/50">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="history" width="20" class="text-primary"></i> Versie Geschiedenis
                    </h3>
                    <p id="history-modal-subtitle" class="text-xs text-slate-400 mt-0.5"></p>
                </div>
                <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 bg-dark" id="history-list-container"></div>
        </div>
    </div>

    <script type="module">
        const STORAGE_KEY_PROJECTS = 'code_projects_v10'; 
        const STORAGE_KEY_ACTIVE_PROJECT = 'active_project_id_v10';
        const STORAGE_KEY_ACTIVE_FILE = 'active_file_id_v10';
        const STORAGE_KEY_ACTIVE_CONTAINER = 'active_container_id_v10';
        const STORAGE_KEY_EXPANDED = 'expanded_containers_v10';

        let activeProjectId = localStorage.getItem(STORAGE_KEY_ACTIVE_PROJECT) || null;
        let activeFileId = localStorage.getItem(STORAGE_KEY_ACTIVE_FILE) || null;
        let activeContainerId = localStorage.getItem(STORAGE_KEY_ACTIVE_CONTAINER) || activeProjectId;
        let expandedContainers = JSON.parse(localStorage.getItem(STORAGE_KEY_EXPANDED) || '[]'); 
        
        let pendingVersionType = null;
        let pendingVersionNote = null;
        let isEditing = false;
        let searchTerm = '';
        let editor;

        // Core Utils
        const generateId = () => Math.random().toString(36).substring(2, 9);
        const countLines = (code) => code.split('\n').length;
        const formatTime = (ts) => new Date(ts).toLocaleString('nl-NL', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
        
        function getAllProjects() { return JSON.parse(localStorage.getItem(STORAGE_KEY_PROJECTS) || '[]'); }
        function saveAllProjects(data) { localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(data)); }
        function getProjectById(id) { return getAllProjects().find(p => p.id === id); }

        // NIEUWE HELPER: Zoek een container (Project of Map) op ID en retourneer het object
        function getContainerById(targetId, items) {
            if (!items) return null;
            for (const item of items) {
                if (item.id === targetId && item.isFolder) {
                    return item;
                }
                if (item.isFolder && item.files) {
                    const found = getContainerById(targetId, item.files);
                    if (found) return found;
                }
            }
            return null;
        }

        // NIEUWE HELPER: Zoek de 'files' array van de container met 'targetId'
        function findContainerArray(targetId, projects) {
            const project = projects.find(p => p.id === activeProjectId);
            if (!project) return null; 

            // Als targetId = Project ID, retourneer de root files array
            if (targetId === activeProjectId) return project.files;
            
            // Zoek recursief in submappen
            function findArray(items) {
                if (!items) return null;
                for (const item of items) {
                    if (item.id === targetId && item.isFolder) {
                        return item.files;
                    }
                    if (item.isFolder && item.files) {
                        const found = findArray(item.files);
                        if (found) return found;
                    }
                }
                return null;
            }
            return findArray(project.files);
        }

        // NIEUWE HELPER: Zoek een bestand (niet een map) op ID
        function getFileById(pId, fId) {
            const p = getProjectById(pId);
            if (!p) return null;
            
            function findFile(items, targetId) {
                for (const item of items) {
                    if (item.id === targetId && !item.isFolder) {
                        return item;
                    }
                    if (item.isFolder && item.files) {
                        const found = findFile(item.files, targetId);
                        if (found) return found;
                    }
                }
                return null;
            }
            return findFile(p.files, fId);
        }
        
        // --- DRAG AND DROP & UPLOAD LOGIC ---
        
        const dragOverlay = document.getElementById('drag-overlay');
        let dragCounter = 0;

        document.body.addEventListener('dragenter', (e) => { e.preventDefault(); dragCounter++; dragOverlay.classList.add('active'); });
        document.body.addEventListener('dragleave', (e) => { e.preventDefault(); dragCounter--; if(dragCounter === 0) dragOverlay.classList.remove('active'); });
        document.body.addEventListener('dragover', (e) => { e.preventDefault(); });

        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            dragOverlay.classList.remove('active');
            
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });

        async function handleFileUpload(file) {
            if (!activeProjectId) return showToast("Selecteer eerst een project om te uploaden.", 'error');

            const defaultNote = `Bestand ${file.name} geüpload`;
            const uploadNote = prompt("Voeg een omschrijving toe voor de upload:", defaultNote);
            if (uploadNote === null) return;

            const textContent = await file.text();
            const projects = getAllProjects();
            const project = projects.find(p => p.id === activeProjectId);
            
            if (!project) return;

            // Zoek de juiste bestandsarray om in te zoeken/toe te voegen
            let targetArray = findContainerArray(activeContainerId, projects);
            if (!targetArray) targetArray = project.files; 

            // Zoek of het bestand al bestaat in deze array (of op hoger niveau)
            const existingFile = targetArray.find(f => f.name === file.name && !f.isFolder);

            if (existingFile) {
                // SCENARIO: BESTAAND BESTAND
                const modal = document.getElementById('upload-modal');
                document.getElementById('upload-filename').textContent = file.name;
                modal.classList.remove('hidden');

                document.getElementById('btn-upload-minor').onclick = () => {
                    processUpdate(project, existingFile, textContent, 'minor', uploadNote || defaultNote);
                    modal.classList.add('hidden');
                };
                document.getElementById('btn-upload-major').onclick = () => {
                    processUpdate(project, existingFile, textContent, 'major', uploadNote || defaultNote);
                    modal.classList.add('hidden');
                };

            } else {
                // SCENARIO: NIEUW BESTAND (v1.0)
                const newFileId = generateId();
                const newVersion = {
                    id: generateId(), code: textContent, timestamp: Date.now(), major: 1, minor: 0,
                    name: "v1.0", note: uploadNote || defaultNote, isStable: true, lineCount: countLines(textContent)
                };

                targetArray.push({
                    id: newFileId, name: file.name, versions: [newVersion], isFolder: false
                });

                saveAllProjects(projects);
                window.setActiveItem(project.id, newFileId);
                showToast(`Bestand '${file.name}' toegevoegd (v1.0)`, 'success');
            }
        }

        function processUpdate(project, fileObj, newCode, type, note) {
            const latest = fileObj.versions[0];
            const maj = type === 'major' ? latest.major + 1 : latest.major;
            const min = type === 'major' ? 0 : latest.minor + 1;

            const newVersion = {
                id: generateId(), code: newCode, timestamp: Date.now(),
                major: maj, minor: min, name: `v${maj}.${min}`,
                note: note, isStable: type === 'major', lineCount: countLines(newCode)
            };

            fileObj.versions.unshift(newVersion);
            saveAllProjects(getAllProjects().map(p => p.id === project.id ? project : p));
            
            window.setActiveItem(project.id, fileObj.id);
            showToast(`Bestand geüpdatet naar ${newVersion.name}`, 'success');
        }

        // --- DOWNLOAD FUNCTION ---
        window.downloadActiveFile = () => {
            if (!activeFileId || !activeProjectId) return showToast("Geen bestand actief", 'error');
            
            const file = getFileById(activeProjectId, activeFileId);
            const content = editor.getValue();
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Download gestart: ${file.name}`, 'success');
        };

        // --- REGULAR WORKFLOW (Major/Minor Button Click) ---
        window.initiateNewVersion = (type) => {
            if (!activeFileId) return showToast("Selecteer eerst een bestand.", 'error');
            
            const note = prompt(`Voeg een omschrijving toe voor deze ${type === 'major' ? 'Major' : 'Minor'} versie:`);
            if (note === null) return;
            
            if (editor.getValue().trim() !== '' && !confirm("De editor wordt leeggemaakt zodat je de nieuwe versie kunt plakken/typen. Doorgaan?")) return;

            pendingVersionType = type;
            pendingVersionNote = note || `Handmatige ${type} update`;
            
            editor.setValue("", -1);
            editor.focus();

            const typeLabel = type === 'major' ? 'MAJOR' : 'MINOR';
            document.getElementById('btn-save-pending').classList.remove('hidden');
            document.getElementById('btn-save-pending').innerHTML = `<i data-lucide="save" width="14"></i> OPSLAAN (${typeLabel})`;
            document.getElementById('action-group-normal').classList.add('opacity-50', 'pointer-events-none');
            
            lucide.createIcons();
            showToast(`Editor is leeg. Plak je nieuwe ${typeLabel} code en klik op OPSLAAN.`, 'info');
        };

        window.commitPendingVersion = () => {
            const content = editor.getValue();
            if(!content.trim()) return showToast("Kan geen lege versie opslaan.", 'error');

            const projects = getAllProjects();
            const p = projects.find(p => p.id === activeProjectId);
            const f = getFileById(activeProjectId, activeFileId);
            if(!f) return;

            const latest = f.versions[0];
            let maj = 1, min = 0;
            if (latest) {
                maj = pendingVersionType === 'major' ? latest.major + 1 : latest.major;
                min = pendingVersionType === 'major' ? 0 : latest.minor + 1;
            }

            const newVersion = {
                id: generateId(), code: content, timestamp: Date.now(),
                major: maj, minor: min, name: `v${maj}.${min}`,
                note: pendingVersionNote, 
                isStable: pendingVersionType === 'major', lineCount: countLines(content)
            };

            f.versions.unshift(newVersion);
            saveAllProjects(projects);

            // Reset state
            pendingVersionType = null;
            pendingVersionNote = null; 
            document.getElementById('btn-save-pending').classList.add('hidden');
            document.getElementById('action-group-normal').classList.remove('opacity-50', 'pointer-events-none');

            renderSidebar(projects);
            loadActiveFile();
            showToast(`Versie ${newVersion.name} succesvol opgeslagen!`, 'success');
        };


        // --- DELETE VERSION FUNCTION ---
        window.deleteVersion = (e, pId, fId, vId, vName) => {
            e.stopPropagation();
            if (confirm(`Weet je zeker dat je versie ${vName} van dit bestand wilt verwijderen? Dit kan niet ongedaan gemaakt worden.`)) {
                const projects = getAllProjects();
                const file = getFileById(pId, fId);

                if (!file) return;

                file.versions = file.versions.filter(v => v.id !== vId);

                if (file.versions.length > 0 && vId === getFileById(pId, fId).versions[0].id) {
                    window.setActiveItem(pId, fId);
                } else if (file.versions.length === 0) {
                    window.setActiveItem(pId, fId); 
                } else {
                    window.openHistoryModal(null, pId, fId);
                }

                saveAllProjects(projects);
                renderSidebar(projects);
                showToast(`Versie ${vName} verwijderd.`, 'success');
            }
        };


        // --- EXPORT PROJECT FUNCTION ---
        window.exportProject = (e, pId) => {
            e.stopPropagation();
            const project = getProjectById(pId);
            if (!project) return showToast("Project niet gevonden.", 'error');

            const exportData = JSON.stringify(project, null, 2);

            const blob = new Blob([exportData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name}_export.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Project '${project.name}' gedownload als JSON.`, 'success');
        };

        // --- NEW PROJECT/FILE/FOLDER CREATION ---
        
        window.saveNewProject = () => {
            const name = prompt("Projectnaam:"); 
            if(!name) return;

            const projects = getAllProjects();
            const pId = generateId();
            
            projects.unshift({ 
                id: pId, 
                name: name, 
                isFolder: true, 
                files: [] 
            });
            
            saveAllProjects(projects);
            window.selectContainer(pId, true); // Selecteer en open de root
            showToast(`Project '${name}' aangemaakt.`, 'success');
        };

        window.createNewItem = (isFolder) => {
            if (!activeProjectId) return showToast("Selecteer eerst een project.", 'error');

            const projects = getAllProjects();
            
            // 1. Zoek de array waar het nieuwe item in moet
            const targetArray = findContainerArray(activeContainerId, projects);
            if (!targetArray) return showToast("Fout: Kon de actieve map niet vinden om item aan toe te voegen.", 'error');
            
            // 2. Vraag om naam
            const nameType = isFolder ? "Mapnaam" : "Bestandsnaam";
            const defaultName = isFolder ? "nieuwe_map" : "nieuw_bestand.js";
            const name = prompt(`${nameType}:`, defaultName); 
            if(!name) return;

            // 3. Creëer item
            const newId = generateId();
            const newItem = { 
                id: newId, 
                name: name, 
                isFolder: isFolder,
                files: isFolder ? [] : undefined, // Alleen mappen hebben 'files'
                versions: isFolder ? undefined : []
            };
            
            targetArray.push(newItem);
            
            saveAllProjects(projects);
            
            if (isFolder) {
                 window.selectContainer(newId, false); // Selecteer de nieuwe map
                 showToast(`Map '${name}' aangemaakt.`, 'success');
            } else {
                 showToast(`Bestand '${name}' aangemaakt.`, 'success');
                 window.setActiveItem(activeProjectId, newId); // Maak bestand direct actief
            }
        };

        // --- Sidebar Navigatie Logic (GEFIXED) ---
        window.selectContainer = (id, isProjectRoot = false) => {
            const projects = getAllProjects();
            const project = projects.find(p => p.id === id || p.files.some(f => f.id === id));
            
            if (isProjectRoot) activeProjectId = id;
            
            // 1. Set Active Container (for adding new items)
            activeContainerId = id;
            localStorage.setItem(STORAGE_KEY_ACTIVE_CONTAINER, id);
            
            // 2. Toggle Expansion
            const index = expandedContainers.indexOf(id);
            if (index > -1) {
                expandedContainers.splice(index, 1);
            } else {
                expandedContainers.push(id);
            }
            localStorage.setItem(STORAGE_KEY_EXPANDED, JSON.stringify(expandedContainers));

            // Deselect active file if we select a container
            if (activeFileId) {
                activeFileId = null; 
                localStorage.removeItem(STORAGE_KEY_ACTIVE_FILE);
            }

            loadActiveFile(); // Rerender sidebar & check editor status
        };

        window.setActiveItem = (pId, fId) => {
            activeProjectId = pId; 
            activeFileId = fId;
            // Stel de container in op de parent van het bestand voor een logische toevoeging
            activeContainerId = pId; // Simpele implementatie: reset naar root bij bestandsselectie
            localStorage.setItem(STORAGE_KEY_ACTIVE_PROJECT, pId); 
            localStorage.setItem(STORAGE_KEY_ACTIVE_FILE, fId); 
            localStorage.setItem(STORAGE_KEY_ACTIVE_CONTAINER, pId); 
            loadActiveFile(); 
        };
        
        // --- Recursief Renderen voor Bestandsboom ---
        function renderFileTree(items, pId, container, level = 0) {
            items.forEach(item => {
                const isActiveF = item.id === activeFileId && pId === activeProjectId && !item.isFolder;
                const isCurrentContainer = item.id === activeContainerId;
                
                if (item.isFolder) {
                    // MAP WEERGAVE
                    const folderIsExpanded = expandedContainers.includes(item.id);
                    
                    const li = document.createElement('li');
                    li.className = "mb-0.5 relative";
                    
                    const folderDiv = document.createElement('div');
                    folderDiv.className = `flex items-center justify-between group px-3 py-1.5 rounded-md cursor-pointer transition-colors ${isCurrentContainer ? 'bg-primary/20' : 'hover:bg-slate-800/50'}`;
                    folderDiv.style.paddingLeft = `${level * 0.75 + 0.75}rem`; 
                    folderDiv.onclick = () => window.selectContainer(item.id, false);
                    
                    folderDiv.innerHTML = `
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i data-lucide="${folderIsExpanded ? 'folder-open' : 'folder'}" class="${isCurrentContainer ? 'text-primary' : 'text-slate-400'}" width="14"></i>
                            <span class="text-xs font-medium ${isCurrentContainer ? 'text-white' : 'text-slate-300'} truncate">${item.name}</span>
                        </div>
                        <i data-lucide="chevron-down" class="text-slate-600 transition-transform ${folderIsExpanded ? 'rotate-180' : ''}" width="12"></i>
                    `;
                    
                    // Visuele boomlijn
                    if (level > 0) {
                        const line = document.createElement('div');
                        line.className = 'absolute left-0 top-0 bottom-0 w-px bg-dark_border ml-3';
                        folderDiv.style.borderLeft = '1px solid #334155';
                    }

                    li.appendChild(folderDiv);
                    container.appendChild(li);

                    if (folderIsExpanded) {
                        const subUl = document.createElement('ul');
                        subUl.className = "ml-3 border-l border-dark_border space-y-0.5";
                        
                        if (item.files.length === 0) {
                            subUl.innerHTML = `<li class="px-2 py-1 text-[10px] text-slate-500 italic" style="padding-left: ${level * 0.75 + 1}rem;">Leeg</li>`;
                        } else {
                             renderFileTree(item.files, pId, subUl, level + 1); 
                        }
                        li.appendChild(subUl);
                    }
                } else {
                    // BESTAND WEERGAVE
                    const latestVer = item.versions.length > 0 ? item.versions[0].name : '-';
                    const fLi = document.createElement('li');
                    
                    fLi.className = `flex items-center justify-between group px-2 py-1.5 rounded cursor-pointer ${isActiveF ? 'bg-primary/20' : 'hover:bg-slate-800'}`;
                    fLi.style.paddingLeft = `${level * 0.75 + 0.75}rem`; 
                    fLi.onclick = () => window.setActiveItem(pId, item.id);
                    
                    fLi.innerHTML = `
                        <div class="flex items-center gap-2 truncate flex-1">
                            <i data-lucide="file-code" width="13" class="${isActiveF ? 'text-primary' : 'text-slate-500'}"></i>
                            <span class="text-xs ${isActiveF ? 'text-white font-medium' : 'text-slate-400'} truncate">${item.name}</span>
                            <span class="text-[10px] text-slate-500 bg-dark_border px-1 rounded ml-1">${latestVer}</span>
                        </div>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                            ${isEditing ? `<button class="p-1 hover:text-red-400 text-slate-500" onclick="window.deleteFile(event, '${pId}', '${item.id}')" title="Verwijder Bestand"><i data-lucide="trash" width="12"></i></button>` : `<button class="p-1.5 hover:bg-slate-700 rounded text-slate-400 hover:text-white" title="Geschiedenis" onclick="window.openHistoryModal(event, '${pId}', '${item.id}')"><i data-lucide="history" width="12"></i></button>`}
                        </div>
                    `;
                    container.appendChild(fLi);
                }
            });
        }


        function renderSidebar(projects) {
            const container = document.getElementById('sidebar-list');
            const infoEl = document.getElementById('active-container-info');
            container.innerHTML = '';
            
            const activeProject = getProjectById(activeProjectId);
            const activeContainer = activeProject ? getContainerById(activeContainerId, activeProject.files) : null;
            
            // Info bar update
            let containerPath = activeProject ? activeProject.name : 'Geen Project';
            if (activeContainer && activeContainerId !== activeProjectId) {
                containerPath += ` / ${activeContainer.name}`;
            } else if (activeProject) {
                containerPath += ' (Root)';
            }
            infoEl.textContent = `Actieve map: ${containerPath}`;

            const filtered = projects.filter(p => p.name.toLowerCase().includes(searchTerm) || p.files.some(f => f.name.toLowerCase().includes(searchTerm)));

            if(filtered.length === 0) { container.innerHTML = `<li class="text-center text-xs text-slate-500 py-4">Geen projecten gevonden.</li>`; return; }

            filtered.forEach(p => {
                const isExpanded = expandedContainers.includes(p.id);
                const isActiveP = p.id === activeProjectId;

                const li = document.createElement('li');
                
                // PROJECT HEADER MET EXPORT KNOP
                li.innerHTML = `
                    <div class="flex items-center justify-between group px-3 py-2 rounded-md cursor-pointer mb-1 transition-colors ${isActiveP ? 'bg-slate-800' : 'hover:bg-slate-800/50'}" onclick="window.selectContainer('${p.id}', true)">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i data-lucide="${isExpanded ? 'folder-open' : 'folder'}" class="${isActiveP ? 'text-primary' : 'text-slate-400'}" width="14"></i>
                            <span class="text-xs font-bold ${isActiveP ? 'text-white' : 'text-slate-300'} truncate">${p.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isExpanded ? 
                                `<button class="p-1 text-slate-500 hover:text-white" onclick="window.exportProject(event, '${p.id}')" title="Exporteer Project (JSON)"><i data-lucide="archive" width="14"></i></button>` : 
                                ''
                            }
                            ${isEditing ? 
                                `<button class="p-1 hover:text-red-400 text-slate-500" onclick="window.deleteProject(event, '${p.id}')" title="Verwijder Project"><i data-lucide="trash" width="12"></i></button>` : 
                                `<i data-lucide="chevron-down" class="text-slate-600 transition-transform ${isExpanded ? 'rotate-180' : ''}" width="12"></i>`
                            }
                        </div>
                    </div>
                `;

                if(isExpanded) {
                    const fileUl = document.createElement('ul');
                    fileUl.className = "space-y-0.5 pl-0";
                    
                    if (p.files.length === 0) {
                        fileUl.innerHTML = `<li class="px-2 py-1 text-[10px] text-slate-500 italic pl-5">Project is leeg.</li>`;
                    } else {
                         renderFileTree(p.files, p.id, fileUl, 0); // Start recursief renderen
                    }
                    
                    li.appendChild(fileUl);
                }
                container.appendChild(li);
            });
            lucide.createIcons();
        }
        // --- ACE EDITOR ZOEK FUNCTIES (NIEUW) ---
        
        window.toggleCodeSearch = () => {
            const searchBar = document.getElementById('code-search-bar');
            searchBar.classList.toggle('hidden');
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('code-search-input').focus();
            } else {
                editor.findAll("", { regExp: false }); // Clear highlighting
            }
        };

        window.closeCodeSearch = () => {
            document.getElementById('code-search-bar').classList.add('hidden');
            editor.find(""); // Clear search/highlighting
        };

        window.findNextInCode = (isNext = true) => {
            const query = document.getElementById('code-search-input').value;
            if (!query) return;

            // Zoek parameters
            const searchOptions = {
                wrap: true,
                caseSensitive: false,
                literal: false,
                regExp: false
            };
            
            // Vind de volgende/vorige instantie
            editor.find(query, searchOptions, isNext);
        };
        
        // Zoeken tijdens typen en Enter/Pijltjes
        document.getElementById('code-search-input').addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length > 2) {
                 // Markeer alle instanties
                 editor.findAll(query, {
                    wrap: true, caseSensitive: false, literal: false, regExp: false
                 });
                 // Ga naar de eerste instantie
                 editor.find(query, {
                    wrap: true, caseSensitive: false, literal: false, regExp: false, preventScroll: false
                 });
            } else {
                editor.find(""); // Wis search/highlighting
            }
        });

        document.getElementById('code-search-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                window.findNextInCode(true); // Volgende bij Enter
            } else if (e.key === 'Escape') {
                window.closeCodeSearch();
            }
        });


        // --- UI CORE ---
        function loadActiveFile() {
            const file = getFileById(activeProjectId, activeFileId);
            const project = getProjectById(activeProjectId);
            const titleEl = document.getElementById('editor-title-status');
            
            pendingVersionType = null; pendingVersionNote = null;
            document.getElementById('btn-save-pending').classList.add('hidden');
            document.getElementById('action-group-normal').classList.remove('opacity-50', 'pointer-events-none');
            window.closeCodeSearch(); // Sluit zoekbalk bij het laden van nieuw bestand

            // De editor is ALTIJD leeg bij geen actieve file/lege file
            editor.setValue("", -1);

            if (file && project) {
                const ext = file.name.split('.').pop().toLowerCase();
                const modeMap = { js:'javascript', html:'html', css:'css', py:'python', json:'json' };
                editor.session.setMode(`ace/mode/${modeMap[ext] || 'text'}`);

                if (file.versions.length > 0) {
                    const latest = file.versions[0];
                    editor.setValue(latest.code, -1);
                    titleEl.innerHTML = `<span class="text-slate-400">${project.name} / </span><span class="text-white">${file.name}</span> <span class="ml-2 text-xs bg-dark_border px-1.5 py-0.5 rounded text-success">${latest.name}</span>`;
                } else {
                    // Lege file, editor is al leeg gesteld
                    titleEl.innerHTML = `<span class="text-slate-400">${project.name} / </span><span class="text-white">${file.name}</span>`;
                }
            } else {
                titleEl.textContent = "Geen bestand geselecteerd";
                const currentProject = getProjectById(activeProjectId);
                if (currentProject) {
                    const container = activeContainerId === currentProject.id ? { name: "(Root)" } : getContainerById(activeContainerId, currentProject.files);
                    titleEl.innerHTML = `<span class="text-slate-400">${currentProject.name} / </span><span class="text-white">${container ? container.name : 'Onbekende map'}</span>`;
                }
            }
            renderSidebar(getAllProjects());
            lucide.createIcons();
        }

        window.openHistoryModal = (e, pId, fId) => {
            if(e) e.stopPropagation();
            const f = getFileById(pId, fId);
            const p = getProjectById(pId);
            if(!f) return;
            document.getElementById('history-modal-subtitle').textContent = `${p.name} / ${f.name}`;
            const listContainer = document.getElementById('history-list-container');
            listContainer.innerHTML = '';
            if(f.versions.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-slate-500 py-10">Geen geschiedenis beschikbaar.</div>`;
            } else {
                f.versions.forEach((v, index) => {
                    const item = document.createElement('div');
                    item.className = "flex items-start justify-between p-3 border-b border-dark_border hover:bg-slate-800/50 transition-colors group";
                    item.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono font-bold text-sm ${v.isStable ? 'text-green-400' : 'text-blue-400'}">${v.name}</span>
                                <span class="text-xs text-slate-500">${formatTime(v.timestamp)}</span>
                                ${index === 0 ? '<span class="text-[10px] bg-primary/20 text-primary px-1 rounded">Huidig</span>' : ''}
                            </div>
                            ${v.note ? `<p class="text-xs text-slate-400 mt-1 italic">"${v.note}"</p>` : ''}
                            <p class="text-[10px] text-slate-600 mt-1">${v.lineCount} regels</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.loadVersionFromHistory('${pId}', '${fId}', '${v.id}')" class="px-3 py-1.5 bg-dark_border hover:bg-slate-600 text-slate-300 text-xs rounded transition-colors flex items-center gap-2" title="Laad deze versie in de editor">
                                <i data-lucide="rotate-ccw" width="12"></i> Laad Code
                            </button>
                            <button onclick="window.deleteVersion(event, '${pId}', '${fId}', '${v.id}', '${v.name}')" class="p-1.5 bg-red-700/30 hover:bg-red-700/60 text-red-400 rounded transition-colors" title="Verwijder Versie ${v.name}">
                                <i data-lucide="trash-2" width="14"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            }
            document.getElementById('history-modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.loadVersionFromHistory = (pId, fId, vId) => {
            const f = getFileById(pId, fId);
            const v = f.versions.find(ver => ver.id === vId);
            if(v) {
                window.setActiveItem(pId, fId);
                editor.setValue(v.code, -1);
                document.getElementById('history-modal').classList.add('hidden');
                const titleEl = document.getElementById('editor-title-status');
                titleEl.innerHTML = `<span class="text-slate-400">${getProjectById(pId).name} / </span><span class="text-white">${f.name}</span> <span class="ml-2 text-xs bg-yellow-500/20 text-yellow-500 px-1.5 py-0.5 rounded border border-yellow-500/30">Geladen: ${v.name}</span>`;
                showToast(`Versie ${v.name} in editor geladen.`, 'info');
            }
        };

        window.toggleEditMode = () => { isEditing = !isEditing; document.getElementById('edit-mode-btn').classList.toggle('bg-primary'); renderSidebar(getAllProjects()); };
        window.deleteProject = (e, id) => { e.stopPropagation(); if(confirm("Project verwijderen?")) { saveAllProjects(getAllProjects().filter(p => p.id !== id)); if(activeProjectId === id) { activeProjectId=null; activeFileId=null; loadActiveFile(); } else renderSidebar(getAllProjects()); } };
        
        window.deleteFile = (e, pId, fId) => { 
            e.stopPropagation(); 
            if(confirm("Bestand/Map verwijderen? (inclusief alle versies/subbestanden)")) { 
                const all = getAllProjects(); 
                const project = all.find(p => p.id === pId);

                function deleteItem(items, targetId) {
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].id === targetId) {
                            items.splice(i, 1);
                            return true;
                        }
                        if (items[i].isFolder && items[i].files) {
                            if (deleteItem(items[i].files, targetId)) return true;
                        }
                    }
                    return false;
                }
                
                deleteItem(project.files, fId);

                saveAllProjects(all); 
                if(activeFileId === fId) { activeFileId=null; loadActiveFile(); } 
                else renderSidebar(all); 
            } 
        };
        
        window.copyCodeToClipboard = () => { navigator.clipboard.writeText(editor.getValue()); showToast("Gekopieerd", 'success'); };
        
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-2xl text-white text-sm font-medium transition-all duration-300 z-50 ${type==='error'?'bg-danger':(type==='success'?'bg-success':'bg-primary')}`;
            t.style.opacity = '1'; t.style.transform = 'translateY(0)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; }, 3000);
        }

        window.exportData = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(getAllProjects(),null,2)], {type:'application/json'})); a.download = 'backup_alles.json'; a.click(); };
        window.triggerImport = () => document.getElementById('importFile').click();
        document.getElementById('importFile').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { saveAllProjects(JSON.parse(ev.target.result)); loadActiveFile(); }; r.readAsText(e.target.files[0]); };

        document.addEventListener('DOMContentLoaded', () => {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night_eighties");
            editor.setOptions({ fontSize: "14px", showPrintMargin: false });
            loadActiveFile();
            document.getElementById('search-input').addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); renderSidebar(getAllProjects()); });
        });
        
        window.saveAllProjects = saveAllProjects;
        window.getAllProjects = getAllProjects;
    </script>
</body>
</html>
