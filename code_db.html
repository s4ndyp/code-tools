<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Versiebeheer</title>
    <!-- Laad Tailwind CSS voor snelle styling en het donkere thema -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome voor iconen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Ace Editor voor Syntax Highlighting (Optie 5) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    
    <script type="module">
        // Globale constantes voor localStorage sleutels (V7)
        const STORAGE_KEY_PROJECTS = 'code_projects_v7'; 
        const STORAGE_KEY_ACTIVE_PROJECT = 'active_project_id_v7';
        const STORAGE_KEY_ACTIVE_FILE = 'active_file_id_v7';

        // Globale staat
        let activeProjectId = localStorage.getItem(STORAGE_KEY_ACTIVE_PROJECT) || null;
        let activeFileId = localStorage.getItem(STORAGE_KEY_ACTIVE_FILE) || null;
        
        let expandedProjectId = activeProjectId; 
        let expandedFileId = null; 
        let isEditing = false;
        let searchTerm = ''; // Voor de zoekfunctie
        
        // Ace Editor Instantie
        let editor;

        // --- HULPFUNCTIES ---

        /**
         * Genereert een unieke ID (eenvoudige UUID-achtige string).
         */
        const generateId = () => {
            return Math.random().toString(36).substring(2, 9);
        };
        
        /**
         * Telt het aantal regels in de gegeven code.
         */
        const countLines = (code) => {
            // Telt het aantal nieuwe regels, inclusief een laatste regel als deze niet leeg is.
            return code.split('\n').length;
        };

        /**
         * Converteert een timestamp naar een leesbaar, gelokaliseerd datum/tijd-formaat.
         */
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'Onbekende datum';
            return new Date(timestamp).toLocaleString('nl-NL', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };
        
        /**
         * Bepaalt de Ace Editor modus op basis van de bestandsnaam.
         */
        const getAceMode = (fileName) => {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'js':
                case 'json':
                    return 'javascript';
                case 'html':
                case 'htm':
                    return 'html';
                case 'css':
                    return 'css';
                case 'py':
                    return 'python';
                case 'ts':
                case 'tsx':
                    return 'typescript';
                case 'jsx':
                    return 'jsx';
                case 'java':
                    return 'java';
                case 'php':
                    return 'php';
                case 'md':
                    return 'markdown';
                case 'sh':
                    return 'sh';
                case 'sql':
                    return 'sql';
                default:
                    return 'text';
            }
        };

        /**
         * Stelt de Ace Editor modus en thema in.
         */
        const setEditorMode = (fileName) => {
            if (!editor) return;
            const mode = getAceMode(fileName);
            editor.session.setMode(`ace/mode/${mode}`);
        };


        // --- LOCAL STORAGE OPSLAAN/LADEN ---

        function getAllProjects() {
            const storedData = localStorage.getItem(STORAGE_KEY_PROJECTS);
            return storedData ? JSON.parse(storedData) : [];
        }

        function saveAllProjects(projects) {
            localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(projects));
        }

        function getProjectById(projectId) {
            const projects = getAllProjects();
            return projects.find(p => p.id === projectId) || null;
        }
        
        /**
         * Haalt een bestand op uit een project.
         */
        function getFileById(projectId, fileId) {
            const project = getProjectById(projectId);
            return project ? project.files.find(f => f.id === fileId) : null;
        }
        
        /**
         * Initialiseert Ace Editor en laadt de code van het actieve bestand.
         */
        function loadActiveFile() {
            const file = getFileById(activeProjectId, activeFileId);
            const project = getProjectById(activeProjectId);
            const editorTitle = document.getElementById('editor-title-status');
            
            if (file && project) {
                // Stel UI expansie in met de UNIEKE SLEUTELS
                expandedProjectId = activeProjectId;
                expandedFileId = `${activeProjectId}-${activeFileId}`;
                
                // Activeer syntax highlighting voor dit bestand
                setEditorMode(file.name);
                
                if (file.versions.length > 0) {
                    const latestVersion = file.versions[0];
                    // Ace Editor: setValue vervangt textarea.value
                    editor.setValue(latestVersion.code, -1); // -1 plaatst cursor bovenaan
                    
                    editorTitle.textContent = ` (Actief: ${project.name} / Bestand: ${file.name} / Geladen: V${latestVersion.major}.${latestVersion.minor})`;
                    editorTitle.classList.remove('text-blue-400');
                    editorTitle.classList.add('text-green-400');
                    
                } else {
                    editor.setValue(`/* Bestand '${file.name}' is actief in project '${project.name}'. Maak een nieuwe versie. */`, -1);
                    editorTitle.textContent = ` (Actief: ${project.name} / Bestand: ${file.name} / Géén Versie)`;
                }
            } else {
                editor.setValue(`
/*
  Welkom bij je Code Versiebeheer App!
  Klik op 'Nieuw Project Opslaan' om een nieuw project te starten.
*/
`, -1);
                editorTitle.textContent = " (Geen actief project)";
                setEditorMode('text.txt'); // Fallback naar platte tekst modus
                activeProjectId = activeFileId = null;
                expandedProjectId = expandedFileId = null;
            }
            renderVersionHistory(getAllProjects());
        }

        // --- ACTIES: NIEUW PROJECT OPSLAAN ---

        /**
         * Slaat de huidige code op als een NIEUW Project met een initieel bestand.
         */
        window.saveNewProject = () => {
            const codeContent = editor.getValue(); // Ace Editor: getValue()

            if (codeContent.trim() === '') {
                showToast("Kan geen leeg nieuw project opslaan.", 'bg-red-500');
                return;
            }

            const projectName = prompt(`Geef een naam op voor het nieuwe Project:`);
            if (!projectName || projectName.trim() === '') {
                showToast("Opslag geannuleerd of ongeldige naam.", 'bg-red-500');
                return;
            }
            
            const fileName = prompt(`Geef een naam op voor het eerste bestand (bv: index.html):`);
             if (!fileName || fileName.trim() === '') {
                showToast("Opslag geannuleerd of ongeldige bestandsnaam.", 'bg-red-500');
                return;
            }
            
            const note = prompt("Voeg een notitie toe voor de eerste Major Versie (V1.0):", "Eerste setup en initieel ontwerp.");
            if (note === null) {
                showToast("Opslag geannuleerd (Notitie vereist).", 'bg-red-500');
                return;
            }


            const projects = getAllProjects();
            const newProjectId = generateId();
            const newFileId = generateId();

            const newVersion = {
                id: generateId(), 
                code: codeContent,
                timestamp: Date.now(),
                major: 1, 
                minor: 0,
                name: "V1.0",
                note: note, // Versie Notitie
                isStable: true,
                lineCount: countLines(codeContent), // Regeltelling
            };
            
            const newFile = {
                id: newFileId,
                name: fileName,
                versions: [newVersion],
            };

            const newProject = {
                id: newProjectId,
                name: projectName,
                files: [newFile],
            };

            projects.unshift(newProject); 
            saveAllProjects(projects);
            
            setActiveItem(newProjectId, newFileId); 
            showToast(`Nieuw Project '${projectName}' succesvol opgeslagen!`, 'bg-green-500');
        }
        
        // --- ACTIES: NIEUW BESTAND MAKEN ---
        
        /**
         * Maakt een nieuw bestand aan in het actieve project.
         */
        window.createNewFile = () => {
            if (!activeProjectId) {
                showToast("Geen actief project geselecteerd. Start een nieuw project.", 'bg-red-500');
                return;
            }

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === activeProjectId);
            if (projectIndex === -1) return;

            const project = projects[projectIndex];

            const fileName = prompt(`Geef een naam op voor het nieuwe bestand in Project '${project.name}' (bv: styles.css):`);
            if (!fileName || fileName.trim() === '') {
                showToast("Opslag geannuleerd of ongeldige naam.", 'bg-red-500');
                return;
            }
            
            const newFileId = generateId();
            const newFile = {
                id: newFileId,
                name: fileName,
                versions: [], // Start zonder versies
            };

            project.files.unshift(newFile);
            saveAllProjects(projects);

            setActiveItem(activeProjectId, newFileId);
            editor.setValue(`/* Nieuw bestand '${fileName}' aangemaakt. Voeg code toe en verhoog de versie! */`, -1); // Ace Editor
            showToast(`Bestand '${fileName}' aangemaakt in project '${project.name}'.`, 'bg-green-500');
        };

        // --- ACTIES: VERSIE OPSLAAN (MAJOR) ---

        /**
         * Voegt de huidige code toe als een nieuwe MAJOR versie (versie ophogen).
         */
        window.saveMajorVersion = () => {
            if (!activeFileId) {
                showToast("Geen actief bestand geselecteerd. Selecteer of maak een bestand aan.", 'bg-red-500');
                return;
            }

            const codeContent = editor.getValue(); // Ace Editor: getValue()
            if (codeContent.trim() === '') {
                showToast("Kan geen lege versie opslaan.", 'bg-red-500');
                return;
            }

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === activeProjectId);
            const project = projects[projectIndex];
            const activeFileIndex = project?.files.findIndex(f => f.id === activeFileId);
            const activeFile = project?.files[activeFileIndex];

            if (!activeFile) return;

            const latestVersion = activeFile.versions.length > 0 ? activeFile.versions[0] : null;

            // Nieuwe Major logica: verhoog major, reset minor
            const major = latestVersion ? latestVersion.major + 1 : 1;
            const minor = 0;
            const versionName = `V${major}.${minor}`;
            
            // Notitie is verplicht bij Major Versie
            const note = prompt(`Voeg een notitie toe voor de Major Versie (${versionName}):`, `Grote feature update of refactoring.`);
            if (note === null) {
                showToast("Opslag geannuleerd (Notitie vereist).", 'bg-red-500');
                return;
            }

            const newVersion = {
                id: generateId(),
                code: codeContent,
                timestamp: Date.now(),
                major: major,
                minor: minor,
                name: versionName,
                note: note, // Versie Notitie
                isStable: true, // Major is standaard stable
                lineCount: countLines(codeContent), // Regeltelling
            };

            // Voeg de nieuwe versie toe aan het begin van de versies (nieuwste bovenaan)
            activeFile.versions.unshift(newVersion);
            saveAllProjects(projects);
            
            renderVersionHistory(projects); 
            showToast(`Major Versie opgehoogd naar V${major}.${minor} voor bestand '${activeFile.name}'.`, 'bg-green-500');
        };

        // --- ACTIES: SUBVERSIE OPSLAAN (MINOR) ---
        
        /**
         * Voegt de huidige code toe als een nieuwe MINOR versie (subversie ophogen).
         */
        window.saveMinorVersion = () => {
            if (!activeFileId) {
                showToast("Geen actief bestand geselecteerd. Selecteer of maak een bestand aan.", 'bg-red-500');
                return;
            }

            const codeContent = editor.getValue(); // Ace Editor: getValue()
            if (codeContent.trim() === '') {
                showToast("Kan geen lege subversie opslaan.", 'bg-red-500');
                return;
            }

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === activeProjectId);
            const project = projects[projectIndex];
            const activeFileIndex = project?.files.findIndex(f => f.id === activeFileId);
            const activeFile = project?.files[activeFileIndex];

            if (!activeFile) {
                showToast("Actief bestand niet gevonden.", 'bg-red-500');
                return;
            }
            
            const latestVersion = activeFile.versions.length > 0 ? activeFile.versions[0] : null;

            if (!latestVersion) {
                showToast("Kan geen subversie maken zonder een basisversie (Maak eerst een Major Versie).", 'bg-red-500');
                return;
            }

            // Subversie Logica: behoud major, verhoog minor
            const major = latestVersion.major;
            const minor = latestVersion.minor + 1;
            const versionName = `V${major}.${minor}`;
            
            // Geen notitie prompt voor Minor Versies (vereenvoudiging)

            const newVersion = {
                id: generateId(),
                code: codeContent,
                timestamp: Date.now(),
                major: major,
                minor: minor,
                name: versionName,
                note: null, // Notitie is nu optioneel/null voor minor
                isStable: false, // Minor is standaard niet stable
                lineCount: countLines(codeContent), // Regeltelling
            };

            activeFile.versions.unshift(newVersion);
            saveAllProjects(projects);
            
            renderVersionHistory(projects); 
            showToast(`Subversie opgehoogd naar V${major}.${minor} voor bestand '${activeFile.name}'.`, 'bg-green-500');
        };
        
        /**
         * Kopieert de inhoud van de code-editor naar het klembord.
         */
        window.copyCodeToClipboard = () => {
            const codeContent = editor.getValue(); // Ace Editor: getValue()
            
            // Gebruik een tijdelijke textarea voor de execCommand('copy') API
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = codeContent;
            document.body.appendChild(tempTextarea);
            
            try {
                tempTextarea.select();
                const success = document.execCommand('copy');
                if (success) {
                    showToast("Code gekopieerd naar klembord!", 'bg-green-600');
                } else {
                    showToast("Kopiëren mislukt. Probeer handmatig te selecteren.", 'bg-red-500');
                }
            } catch (err) {
                console.error('Fout bij kopiëren:', err);
                showToast("Kopiëren mislukt. Probeer handmatig te selecteren.", 'bg-red-500');
            } finally {
                document.body.removeChild(tempTextarea);
            }
        };
        
        /**
         * Maakt de editor leeg na bevestiging.
         */
        window.clearEditor = () => {
            if (confirm("Weet je zeker dat je de huidige inhoud van de editor wilt wissen? Dit wordt NIET opgeslagen!")) {
                editor.setValue('', -1);
                showToast("Editor leeggemaakt.", 'bg-red-500');
            }
        };


        // --- DATA EXPORT/IMPORT LOGICA ---

        window.exportData = () => {
            const allProjects = getAllProjects();
            if (allProjects.length === 0) {
                showToast("Geen gegevens om te exporteren.", 'bg-red-500');
                return;
            }
            const dataStr = JSON.stringify(allProjects, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().slice(0, 10);
            link.download = `code_version_backup_${date}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast("Gegevens succesvol geëxporteerd!", 'bg-indigo-600');
        };

        window.triggerImport = () => {
            document.getElementById('importFile').click();
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Initialiseer Ace Editor
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night_eighties"); // Donker thema
            editor.session.setMode("ace/mode/text"); // Standaardmodus
            editor.setOptions({
                fontSize: "14px", // Kleinere lettergrootte om het veld goed te vullen
                showPrintMargin: false,
                useWorker: false 
            });
            editor.container.style.lineHeight = "1.5"; // Lijnhoogte aanpassen


            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.addEventListener('change', handleImport);
            }
            loadActiveFile(); // Laadt de actieve file code EN rendert de geschiedenis
            document.getElementById('storage-info').textContent = 'Opslag: Local Storage (Browser)';
            
            // Event listener voor de zoekbalk
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderVersionHistory(getAllProjects());
            });
        });

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedProjects = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedProjects)) {
                        throw new Error("Ongeldig JSON-formaat: verwacht een array.");
                    }

                    // Eenvoudige validatie voor V7 structuur
                    if (importedProjects.length > 0 && (!importedProjects[0].id || !Array.isArray(importedProjects[0].files))) {
                         throw new Error("Ongeldige datastructuur in JSON. Zorg ervoor dat het een geldige V7 backup is.");
                    }

                    if (!confirm(`Weet je zeker dat je ${importedProjects.length} projecten wilt importeren? Dit zal alle HUIDIGE data OVERSSCHRIJVEN.`)) {
                        showToast("Import geannuleerd.", 'bg-gray-500');
                        return;
                    }
                    
                    saveAllProjects(importedProjects);
                    activeProjectId = activeFileId = null;
                    localStorage.removeItem(STORAGE_KEY_ACTIVE_PROJECT);
                    localStorage.removeItem(STORAGE_KEY_ACTIVE_FILE);
                    loadActiveFile();
                    
                    showToast(`Succesvol ${importedProjects.length} projecten geïmporteerd!`, 'bg-green-600');

                } catch (error) {
                    console.error("Fout bij importeren:", error);
                    showToast(`Import mislukt: ${error.message}`, 'bg-red-600');
                }
            };
            reader.readAsText(file);
            
            event.target.value = null; 
        }

        // --- SCHAKEL LOGICA ---

        /**
         * Stelt een project en bestand in als actief en werkt de editor bij.
         */
        window.setActiveItem = (projectId, fileId) => {
            activeProjectId = projectId;
            activeFileId = fileId; 
            
            // Gebruik de unieke samengestelde sleutels voor de expanded states
            expandedProjectId = projectId; 
            expandedFileId = `${projectId}-${fileId}`; 
            
            localStorage.setItem(STORAGE_KEY_ACTIVE_PROJECT, projectId);
            localStorage.setItem(STORAGE_KEY_ACTIVE_FILE, fileId);

            loadActiveFile(); // Laadt code, toont toast en rendert UI
        };

        /**
         * Laadt een specifieke versie in de editor.
         */
        window.switchVersionHandler = (projectId, fileId, versionId) => {
            if (isEditing) return; 

            const file = getFileById(projectId, fileId);
            const project = getProjectById(projectId);
            if (!file || !project) return;

            const version = file.versions.find(v => v.id === versionId);

            if (version) {
                // Zet de geladen versie als actief
                if (activeFileId !== fileId || activeProjectId !== projectId) {
                    setActiveItem(projectId, fileId);
                }
                
                // Ace Editor: setValue
                editor.setValue(version.code, -1); 
                setEditorMode(file.name); // Stel modus in op basis van het geladen bestand

                showToast(`Versie V${version.major}.${version.minor} geladen uit bestand '${file.name}'.`, 'bg-blue-600');
                
                const editorTitle = document.getElementById('editor-title-status');
                editorTitle.textContent = ` (Actief: ${project.name} / Bestand: ${file.name} / Geladen: V${version.major}.${version.minor})`;
                editorTitle.classList.remove('text-green-400');
                editorTitle.classList.add('text-blue-400');
            }
        };
        
        // --- KLAP-UIT/KLAP-IN LOGICA is ongewijzigd ---

        /**
         * Klapt de bestanden van een project in of uit.
         */
        window.toggleFiles = (projectId) => {
            if (isEditing) return;

            // Inklappen van eventuele andere uitgeklapte projecten
            if (expandedProjectId && expandedProjectId !== projectId) {
                document.getElementById(`file-list-container-${expandedProjectId}`).classList.add('hidden');
                document.getElementById(`project-caret-${expandedProjectId}`).classList.remove('rotate-180');
            }

            const currentContainer = document.getElementById(`file-list-container-${projectId}`);
            const currentCaret = document.getElementById(`project-caret-${projectId}`);

            if (currentContainer.classList.contains('hidden')) {
                currentContainer.classList.remove('hidden');
                currentCaret.classList.add('rotate-180');
                expandedProjectId = projectId;
            } else {
                currentContainer.classList.add('hidden');
                currentCaret.classList.remove('rotate-180');
                expandedProjectId = null;
            }
        };


        /**
         * Klapt de versies van een bestand in of uit.
         * De unieke sleutel is ProjectID-FileID.
         */
        window.toggleVersions = (uniqueFileKey) => {
            if (isEditing) return;

            // 1. Klap de eerder uitgeklapte file (versions) in (indien verschillend)
            if (expandedFileId && expandedFileId !== uniqueFileKey) {
                const oldContainer = document.getElementById(`version-list-container-${expandedFileId}`);
                const oldCaret = document.getElementById(`file-caret-${expandedFileId}`);
                if (oldContainer) oldContainer.classList.add('hidden');
                if (oldCaret) oldCaret.classList.remove('rotate-180');
            }

            // 2. Toon/verberg de huidige
            const currentContainer = document.getElementById(`version-list-container-${uniqueFileKey}`);
            const currentCaret = document.getElementById(`file-caret-${uniqueFileKey}`);

            if (currentContainer.classList.contains('hidden')) {
                currentContainer.classList.remove('hidden');
                currentCaret.classList.add('rotate-180');
                expandedFileId = uniqueFileKey;
            } else {
                currentContainer.classList.add('hidden');
                currentCaret.classList.remove('rotate-180');
                expandedFileId = null;
            }
        };
        
        // --- RENAME LOGICA is ongewijzigd ---
        
        window.renameProject = (projectId, currentName) => {
            if (!isEditing) return;
            const newName = prompt(`Hernoem Project '${currentName}':`, currentName);
            if (!newName || newName.trim() === '' || newName === currentName) return;
            
            const projects = getAllProjects();
            const project = projects.find(p => p.id === projectId);
            if (project) {
                project.name = newName;
                saveAllProjects(projects);
                loadActiveFile(); 
                showToast(`Project hernoemd naar '${newName}'.`, 'bg-indigo-600');
            }
        };
        
        window.renameFile = (projectId, fileId, currentName) => {
            if (!isEditing) return;
            const newName = prompt(`Hernoem Bestand '${currentName}':`, currentName);
            if (!newName || newName.trim() === '' || newName === currentName) return;
            
            const projects = getAllProjects();
            const project = projects.find(p => p.id === projectId);
            const file = project?.files.find(f => f.id === fileId);
            
            if (file) {
                file.name = newName;
                saveAllProjects(projects);
                loadActiveFile(); 
                showToast(`Bestand hernoemd naar '${newName}'.`, 'bg-indigo-600');
            }
        };
        
        // --- CODE KOPIËREN (Versie) is ongewijzigd ---
        
        window.copyVersionCode = (projectId, fileId, versionId) => {
             const file = getFileById(projectId, fileId);
             const version = file?.versions.find(v => v.id === versionId);
             
             if (!version) {
                 showToast("Versiecode niet gevonden.", 'bg-red-500');
                 return;
             }
             
             // Gebruik een tijdelijke textarea voor de execCommand('copy') API
             const tempTextarea = document.createElement('textarea');
             tempTextarea.value = version.code;
             document.body.appendChild(tempTextarea);
             tempTextarea.select();
             document.execCommand('copy');
             document.body.removeChild(tempTextarea);
             
             showToast(`Code V${version.major}.${version.minor} gekopieerd!`, 'bg-green-600');
        };
        
        // --- PREVIEW/DIFF MODAL LOGICA (VERWIJDERD) ---
        // De functies showDiffModal en closeDiffModal zijn verwijderd, net als de modal markup.


        /**
         * Schakelt de stable labelstatus van een specifieke versie in localStorage.
         */
        window.toggleVersionLabel = (projectId, fileId, versionId, labelType) => {
            // labelType is altijd 'isStable'
            if (isEditing || labelType !== 'isStable') return; 

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === projectId);
            const fileIndex = projects[projectIndex]?.files.findIndex(f => f.id === fileId);
            
            if (projectIndex === -1 || fileIndex === -1) return;

            const versionIndex = projects[projectIndex].files[fileIndex].versions.findIndex(v => v.id === versionId);
            
            if (versionIndex === -1) return;
            
            const currentStatus = projects[projectIndex].files[fileIndex].versions[versionIndex][labelType];
            projects[projectIndex].files[fileIndex].versions[versionIndex][labelType] = !currentStatus;

            saveAllProjects(projects);
            renderVersionHistory(projects); 
            showToast(`Stable label ${!currentStatus ? 'ingeschakeld' : 'uitgeschakeld'}.`, 'bg-indigo-600');
        };

        // --- VERWIJDER LOGICA is ongewijzigd ---

        /**
         * Schakelt de bewerkingsmodus in/uit en rendert de geschiedenis opnieuw.
         */
        window.toggleEditMode = () => {
            isEditing = !isEditing;
            const editButton = document.getElementById('edit-mode-button');
            editButton.classList.toggle('bg-red-500', isEditing);
            editButton.classList.toggle('hover:bg-red-600', isEditing);
            editButton.classList.toggle('bg-gray-600', !isEditing);
            editButton.classList.toggle('hover:bg-gray-700', !isEditing);
            editButton.textContent = isEditing ? 'Bewerk Modus (Aan)' : 'Bewerk Modus (Uit)';

            showToast(isEditing ? "Bewerk Modus Ingeschakeld. Klik op prullenbakjes om te verwijderen of potloodjes om te hernoemen." : "Bewerk Modus Uitgeschakeld.", 'bg-yellow-600');
            renderVersionHistory(getAllProjects());
        };
        
        window.deleteProject = (projectId) => {
            if (!confirm("Weet je zeker dat je dit HELE PROJECT, inclusief alle bestanden en versies, wilt verwijderen?")) return;

            let projects = getAllProjects();
            projects = projects.filter(p => p.id !== projectId);
            saveAllProjects(projects);

            if (activeProjectId === projectId) {
                activeProjectId = activeFileId = null;
                localStorage.removeItem(STORAGE_KEY_ACTIVE_PROJECT);
                localStorage.removeItem(STORAGE_KEY_ACTIVE_FILE);
                loadActiveFile();
            } else {
                renderVersionHistory(projects);
            }
            showToast("Project succesvol verwijderd.", 'bg-red-600');
        };

        window.deleteFile = (projectId, fileId) => {
            if (!confirm("Weet je zeker dat je dit BESTAND en alle versies erin wilt verwijderen?")) return;

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === projectId);
            if (projectIndex === -1) return;

            let project = projects[projectIndex];
            project.files = project.files.filter(f => f.id !== fileId);

            if (activeProjectId === projectId && activeFileId === fileId) {
                const newActiveFile = project.files[0];
                setActiveItem(projectId, newActiveFile ? newActiveFile.id : null);
            } else {
                saveAllProjects(projects);
                renderVersionHistory(projects);
            }
            showToast("Bestand succesvol verwijderd.", 'bg-red-600');
        };

        window.deleteVersion = (projectId, fileId, versionId) => {
            if (!confirm("Weet je zeker dat je deze VERSIE wilt verwijderen?")) return;

            const projects = getAllProjects();
            const projectIndex = projects.findIndex(p => p.id === projectId);
            const fileIndex = projects[projectIndex]?.files.findIndex(f => f.id === fileId);
            if (projectIndex === -1 || fileIndex === -1) return;

            let file = projects[projectIndex].files[fileIndex];
            file.versions = file.versions.filter(v => v.id !== versionId);

            saveAllProjects(projects);
            renderVersionHistory(projects);
            showToast("Versie succesvol verwijderd.", 'bg-red-600');
        };


        // --- UI RENDERING (met Zoek- en Lijnvergelijking) ---

        /**
         * Rendert de lijst met projecten, bestanden en hun versies.
         */
        function renderVersionHistory(projects) {
            const historyContainer = document.getElementById('version-history');
            historyContainer.innerHTML = '';
            
            // Filter projecten op basis van de zoekterm
            const filteredProjects = projects.filter(project => 
                project.name.toLowerCase().includes(searchTerm) ||
                project.files.some(file => file.name.toLowerCase().includes(searchTerm))
            );

            if (filteredProjects.length === 0 && projects.length > 0) {
                 historyContainer.innerHTML = `<p class="p-4 text-gray-400 text-sm">Geen resultaten gevonden voor '${document.getElementById('search-input').value}'.</p>`;
                 return;
            } else if (projects.length === 0) {
                historyContainer.innerHTML = `<p class="p-4 text-gray-400 text-sm">Nog geen projecten opgeslagen. Gebruik de knop 'Nieuw Project Opslaan'.</p>`;
                return;
            }

            filteredProjects.forEach((project) => {
                const isActiveProject = project.id === activeProjectId;
                const isExpandedProject = project.id === expandedProjectId;

                // 1. PROJECT TITEL
                const projectItem = document.createElement('li');
                projectItem.className = `p-3 mt-2 transition duration-150 rounded-md ${isActiveProject ? 'bg-green-700/50 border-2 border-green-500' : 'bg-gray-700/50 hover:bg-gray-700'}`;
                
                projectItem.innerHTML = `
                    <div class="flex justify-between items-center text-white cursor-pointer" onclick="window.toggleFiles('${project.id}')">
                        <div class="flex items-center space-x-2 truncate">
                            ${!isEditing ? 
                                `<svg id="project-caret-${project.id}" class="w-4 h-4 transition-transform duration-200 ${isExpandedProject ? 'rotate-180' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`
                                : ''}
                            <span class="truncate font-bold text-lg">${project.name} ${isActiveProject ? ' (Huidig)' : ''}</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            ${isEditing ? 
                                `<button class="text-gray-400 hover:text-yellow-400 p-1" onclick="event.stopPropagation(); renameProject('${project.id}', '${project.name}')" title="Hernoem project">
                                    <i class="fas fa-pencil-alt text-sm"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-400 p-1" onclick="event.stopPropagation(); deleteProject('${project.id}')" title="Verwijder project">
                                    <i class="fas fa-trash-alt"></i>
                                </button>` 
                                : ''}
                        </div>
                    </div>
                `;
                historyContainer.appendChild(projectItem);

                // 2. FILES CONTAINER 
                const fileListContainer = document.createElement('ul');
                fileListContainer.id = `file-list-container-${project.id}`;
                fileListContainer.className = isExpandedProject ? 'block divide-y divide-gray-700 pl-4' : 'hidden divide-y divide-gray-700 pl-4'; 
                
                // Filter bestanden op basis van zoekterm
                const filteredFiles = project.files.filter(file => file.name.toLowerCase().includes(searchTerm));
                
                if (filteredFiles.length === 0) {
                    fileListContainer.innerHTML = `<li class="py-2 text-gray-500 text-xs pl-2">Geen bestanden in dit project die matchen met de zoekterm.</li>`;
                } else {
                    filteredFiles.forEach((file) => {
                        const isActiveFile = file.id === activeFileId && isActiveProject;

                        // File Unieke ID
                        const uniqueFileKey = `${project.id}-${file.id}`;
                        const isExpandedFile = uniqueFileKey === expandedFileId;

                        // File Titel
                        const fileItem = document.createElement('li');
                        fileItem.className = `py-2 mt-1 font-normal transition duration-150 rounded-md ${isActiveFile ? 'bg-gray-700 border-l-2 border-blue-500' : 'hover:bg-gray-700'}`;

                        fileItem.innerHTML = `
                            <div class="flex justify-between items-center text-white cursor-pointer p-2" onclick="window.toggleVersions('${uniqueFileKey}')">
                                <div class="flex items-center space-x-2 truncate">
                                    ${!isEditing ? 
                                        `<svg id="file-caret-${uniqueFileKey}" class="w-3 h-3 transition-transform duration-200 ${isExpandedFile ? 'rotate-180' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`
                                        : ''}
                                    <span class="text-gray-400 truncate text-sm">${file.name} ${isActiveFile ? ' (Actief)' : ''}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${!isActiveFile && !isEditing ? 
                                        `<button class="text-xs bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-0.5 px-2 rounded-lg shadow-sm ml-4"
                                                onclick="event.stopPropagation(); setActiveItem('${project.id}', '${file.id}')">
                                            Activeer
                                        </button>` 
                                        : ''}
                                    ${isEditing ? 
                                        `<button class="text-gray-400 hover:text-yellow-400 p-1" onclick="event.stopPropagation(); renameFile('${project.id}', '${file.id}', '${file.name}')" title="Hernoem bestand">
                                            <i class="fas fa-pencil-alt text-sm"></i>
                                        </button>
                                        <button class="text-red-500 hover:text-red-400 p-1" onclick="event.stopPropagation(); deleteFile('${project.id}', '${file.id}')" title="Verwijder bestand">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>` 
                                        : ''}
                                </div>
                            </div>
                        `;
                        fileListContainer.appendChild(fileItem);

                        // 3. VERSIES CONTAINER 
                        const versionListContainer = document.createElement('ul');
                        versionListContainer.id = `version-list-container-${uniqueFileKey}`; 
                        versionListContainer.className = isExpandedFile ? 'block divide-y divide-gray-700' : 'hidden divide-y divide-gray-700'; 
                        
                        if (file.versions.length === 0) {
                            versionListContainer.innerHTML = `<li class="pl-8 py-2 text-gray-500 text-xs">Geen versies in dit bestand.</li>`;
                        } else {
                            file.versions.forEach((v, index) => {
                                const versionItem = document.createElement('li');
                                versionItem.className = 'pl-8 py-2 hover:bg-gray-700 transition duration-150 cursor-pointer';
                                
                                // Bepaal Lijnvergelijking
                                let lineCountColor = 'text-gray-500'; // Standaard
                                if (index < file.versions.length - 1) {
                                    const nextVersion = file.versions[index + 1]; // Vorige versie in de tijd
                                    const lineCountDifference = v.lineCount - (nextVersion.lineCount || 0);
                                    
                                    if (lineCountDifference > 0) {
                                        lineCountColor = 'text-green-400'; // Meer regels
                                    } else if (lineCountDifference < 0) {
                                        lineCountColor = 'text-red-400'; // Minder regels
                                    } else {
                                        lineCountColor = 'text-blue-400'; // Gelijk aantal regels
                                    }
                                }

                                versionItem.innerHTML = `
                                    <div class="flex justify-between items-center" title="${v.note || 'Geen notitie'}">
                                        <div class="font-normal text-gray-200 truncate mr-2 text-xs flex flex-col">
                                            <span>${v.name}</span>
                                            ${v.note ? `<span class="text-gray-200 truncate italic text-[10px]">${v.note}</span>` : ''}
                                        </div>
                                        <div class="text-xs flex-shrink-0 flex flex-col items-end">
                                            <p class="text-gray-500">${formatTimestamp(v.timestamp)}</p>
                                            <p class="${lineCountColor} font-semibold mt-1">
                                                ${v.lineCount} ${v.lineCount === 1 ? 'regel' : 'regels'}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-2">
                                        <div class="flex items-center space-x-2">
                                            <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-2 rounded-lg shadow-sm ${isEditing ? 'opacity-50 cursor-not-allowed' : ''}"
                                                    ${isEditing ? 'disabled' : ''}
                                                    onclick="switchVersionHandler('${project.id}', '${file.id}', '${v.id}')">
                                                Laad Versie
                                            </button>
                                            
                                            <button class="text-xs text-gray-300 hover:text-white bg-gray-600 hover:bg-gray-700 font-medium py-1 px-2 rounded-lg shadow-sm ${isEditing ? 'opacity-50 cursor-not-allowed' : ''}"
                                                    ${isEditing ? 'disabled' : ''}
                                                    onclick="copyVersionCode('${project.id}', '${file.id}', '${v.id}')" title="Kopieer versiecode naar klembord">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            
                                            <div class="flex items-center" onclick="event.stopPropagation()">
                                                <input type="checkbox" id="stable-${v.id}" class="h-4 w-4 rounded focus:ring-green-500 bg-gray-600 border-gray-600 checked:text-green-600 ${isEditing ? 'opacity-50 cursor-not-allowed' : ''}"
                                                    ${v.isStable ? 'checked' : ''}
                                                    ${isEditing ? 'disabled' : ''}
                                                    onclick="toggleVersionLabel('${project.id}', '${file.id}', '${v.id}', 'isStable')">
                                                <label for="stable-${v.id}" class="ml-1 text-sm text-green-600 select-none font-medium ${isEditing ? 'opacity-50' : ''}">Stable</label>
                                            </div>
                                            
                                        </div>
                                        ${isEditing ? 
                                            `<button class="text-red-500 hover:text-red-400" onclick="deleteVersion('${project.id}', '${file.id}', '${v.id}')" title="Verwijder versie">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>` 
                                            : ''}
                                    </div>
                                `;
                                versionListContainer.appendChild(versionItem);
                            });
                        }
                        fileListContainer.appendChild(versionListContainer);
                    });
                }
                historyContainer.appendChild(fileListContainer);
            });
        }


        // --- TOAST/MELDING FUNCTIE ---

        /**
         * Toont een tijdelijke melding.
         */
        function showToast(message, bgColor) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 z-50 ${bgColor}`;
            toast.style.opacity = '1';

            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // Initialiseer bij het laden van de pagina
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiseer Ace Editor
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night_eighties"); // Donker thema
            editor.session.setMode("ace/mode/text"); // Standaardmodus
            editor.setOptions({
                fontSize: "14px", // Kleinere lettergrootte om het veld goed te vullen
                showPrintMargin: false,
                useWorker: false 
            });
            editor.container.style.lineHeight = "1.5"; // Lijnhoogte aanpassen


            const importInput = document.getElementById('importFile');
            if (importInput) {
                importInput.addEventListener('change', handleImport);
            }
            loadActiveFile(); // Laadt de actieve file code EN rendert de geschiedenis
            document.getElementById('storage-info').textContent = 'Opslag: Local Storage (Browser)';
            
            // Event listener voor de zoekbalk
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderVersionHistory(getAllProjects());
            });
        });

        // Bind de opslagfuncties aan de knoppen
        window.saveNewProject = saveNewProject;
        window.saveMajorVersion = saveMajorVersion;
        window.saveMinorVersion = saveMinorVersion;
    </script>

    <style>
        /* Aangepaste scrollbar voor een donker thema */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d3748; /* dark gray */
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* slightly lighter dark gray */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* light gray */
        }

        /* Styling voor de Ace Editor container (vervangt textarea) */
        #editor {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            /* Ace Editor beheert de hoogte en overflow */
            width: 100%; 
            height: 100%;
            border: 1px solid #4a5568; /* Border van de textarea behouden */
            border-radius: 0.5rem; /* rounded-lg */
        }
        
        /* Zorgt ervoor dat de Ace Editor de donkere achtergrond van de container overneemt */
        .ace_editor {
            background-color: #1a202c !important; /* bg-gray-900 */
            color: #68d391 !important; /* text-green-300 */
        }
        
        /* De rand van de editor container om de Ace Editor heen */
        .editor-container {
             border-radius: 0.5rem; /* rounded-lg */
             overflow: hidden; /* Om te zorgen dat de Ace Editor niet over de rand gaat */
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div class="flex flex-col md:flex-row h-screen">

        <!-- Linkerpaneel: Code Editor -->
        <main class="flex-1 flex flex-col p-4 bg-gray-800 shadow-lg md:overflow-y-auto">
            <!-- Header met Titel, Status en Nieuwe Klembord Knop -->
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-green-400 flex items-baseline">
                    Code-editor 
                    <span id="editor-title-status" class="text-base font-normal ml-2 text-green-400"> (Geen actief project)</span>
                </h1>
                <!-- Icoonknoppen: Kopiëren en Wissen -->
                <div class="flex space-x-2">
                    <!-- Klembord Knop -->
                    <button onclick="window.copyCodeToClipboard()" title="Kopieer inhoud naar klembord"
                            class="p-2 text-gray-400 hover:text-green-400 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-150 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <i class="fas fa-clipboard text-xl"></i>
                    </button>
                    <!-- Wis Editor Knop (Nieuw) -->
                    <button onclick="window.clearEditor()" title="Wis Editor Inhoud"
                            class="p-2 text-red-400 hover:text-red-300 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <i class="fas fa-eraser text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 relative editor-container">
                <!-- ACE EDITOR CONTAINER (vervangt textarea) -->
                <div id="editor">
/*
  Welkom bij je Code Versiebeheer App!
  Dit is de plek waar je je code schrijft.
  Sla een versie op om een momentopname te maken in de geschiedenis.
*/
function greet(name) {
    console.log("Hallo, " + name + "!");
}

greet("Wereld");
                </div>
            </div>

            <div class="mt-4 flex justify-between items-center">
                <div class="flex space-x-4">
                    <button id="new-file-button"
                            onclick="window.saveNewProject()"
                            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-xl transform hover:scale-[1.02] transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        Nieuw Project Opslaan
                    </button>
                    
                    <button id="increment-major-button"
                            onclick="window.saveMajorVersion()"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-xl transform hover:scale-[1.02] transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                        Versie Ophogen (Major)
                    </button>

                    <button id="increment-minor-button"
                            onclick="window.saveMinorVersion()"
                            class="px-6 py-3 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-lg shadow-xl transform hover:scale-[1.02] transition duration-200 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50">
                        Subversie Ophogen (Minor)
                    </button>

                    <button id="new-file-button-in-branch"
                            onclick="window.createNewFile()"
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-xl transform hover:scale-[1.02] transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                        Nieuw Bestand Maken
                    </button>
                </div>
                
                <!-- Export/Import Knoppen en Storage Info -->
                <div class="flex items-center space-x-4">
                    <button onclick="window.exportData()"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Exporteer (JSON)
                    </button>
                    
                    <input type="file" id="importFile" accept=".json" class="hidden">
                    <button onclick="window.triggerImport()"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Importeer (JSON)
                    </button>

                    <div id="storage-info" class="text-xs text-gray-400 truncate ml-4">Opslag: Initialiseren...</div>
                </div>
            </div>
        </main>

        <!-- Rechterpaneel: History -->
        <aside class="w-full md:w-80 flex flex-col bg-gray-800 border-l border-gray-700">
            <div class="flex flex-col p-4 bg-gray-900 border-b border-gray-700 sticky top-0 z-10">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-yellow-400">History</h2>
                    <button id="edit-mode-button"
                            onclick="window.toggleEditMode()"
                            class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-medium py-0.5 px-2 rounded-lg shadow-md transition duration-200">
                        Bewerk Modus (Uit)
                    </button>
                </div>
                
                <!-- Zoekbalk -->
                <input type="text" id="search-input" placeholder="Zoek project, bestand of versie..."
                       class="w-full p-2 text-sm bg-gray-800 text-gray-200 border border-gray-600 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 outline-none">
            </div>
            
            <ul id="version-history" class="overflow-y-auto flex-1 divide-y divide-gray-700">
                <!-- Projecten, Bestanden en versies worden hier dynamisch geladen -->
                <p class="p-4 text-gray-400 text-sm">Projecten worden geladen...</p>
            </ul>
        </aside>
    </div>
    
    <!-- Toast Melding -->
    <div id="toast" style="opacity: 0;" class="fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-xl transition-opacity duration-300 z-50 bg-gray-700">
        Melding
    </div>
</body>
</html>
