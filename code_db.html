<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Versiebeheer - Project Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: '#0f172a', dark_paper: '#1e293b', dark_border: '#334155',
                        primary: '#6366f1', primary_hover: '#4f46e5', success: '#22c55e', danger: '#ef4444'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        #editor { font-family: 'JetBrains Mono', monospace; width: 100%; height: 100%; }
        .ace_editor { background-color: #0f172a !important; color: #e2e8f0 !important; }
        .ace_gutter { background-color: #1e293b !important; color: #64748b !important; border-right: 1px solid #334155 !important; }
        .ace_cursor { color: #6366f1 !important; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="flex h-screen w-screen">

    <aside class="flex flex-col w-72 h-full bg-dark_paper border-r border-dark_border flex-shrink-0 z-20 transition-all duration-300 relative" id="sidebar">
        <div class="p-4 border-b border-dark_border flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-primary to-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                <i data-lucide="git-branch" width="18"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm text-white">Code Repo</h1>
                <p class="text-[10px] text-slate-400">Versiebeheer</p>
            </div>
        </div>

        <div class="p-3 border-b border-dark_border bg-dark_paper space-y-2">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-500" width="14"></i>
                <input type="text" id="search-input" placeholder="Zoeken..." class="w-full bg-dark border border-dark_border text-slate-300 text-xs rounded-md pl-9 pr-2 py-2 focus:outline-none focus:border-primary">
            </div>
            <div class="flex gap-2">
                 <button onclick="window.saveNewProject()" class="flex-1 bg-primary hover:bg-primary_hover text-white text-xs py-1.5 px-2 rounded transition-colors flex items-center justify-center gap-1 font-medium">
                    <i data-lucide="plus" width="12"></i> Project
                </button>
                <button onclick="window.toggleEditMode()" id="edit-mode-btn" class="bg-dark border border-dark_border hover:bg-slate-700 text-slate-400 text-xs py-1.5 px-2 rounded" title="Beheer Modus">
                    <i data-lucide="settings-2" width="14"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2">
            <ul id="sidebar-list" class="space-y-1"></ul>
        </div>

        <div class="p-3 border-t border-dark_border text-[10px] text-slate-500 flex justify-between items-center bg-dark_paper">
            <span>Local Storage</span>
            <div class="flex gap-2">
                <button onclick="window.exportData()" class="hover:text-white" title="Export JSON"><i data-lucide="download" width="12"></i></button>
                <button onclick="window.triggerImport()" class="hover:text-white" title="Import JSON"><i data-lucide="upload" width="12"></i></button>
            </div>
            <input type="file" id="importFile" accept=".json" class="hidden">
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-dark relative min-w-0">
        <div class="h-14 border-b border-dark_border bg-dark_paper flex items-center justify-between px-4 flex-shrink-0">
            <div class="flex items-center gap-2 overflow-hidden">
                <i data-lucide="file-code" class="text-primary flex-shrink-0" width="18"></i>
                <span id="editor-title-status" class="text-sm font-medium text-slate-200 truncate">Geen bestand geselecteerd</span>
            </div>
            
            <div class="flex items-center gap-2">
                
                <button id="btn-save-pending" onclick="window.commitPendingVersion()" class="hidden animate-pulse bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-green-900/20 flex items-center gap-2 mr-4 transition-all">
                    <i data-lucide="save" width="14"></i> WIJZIGINGEN OPSLAAN
                </button>

                <div id="action-group-normal" class="flex items-center gap-2">
                    <div class="flex bg-dark rounded-lg p-1 border border-dark_border">
                        <button onclick="window.initiateNewVersion('major')" class="p-1.5 hover:bg-slate-700 rounded text-green-400 transition-colors tooltip" title="Start nieuwe Major versie (Maakt editor leeg)">
                            <span class="text-xs font-bold px-1">Major++</span>
                        </button>
                        <div class="w-px bg-dark_border my-1"></div>
                        <button onclick="window.initiateNewVersion('minor')" class="p-1.5 hover:bg-slate-700 rounded text-blue-400 transition-colors tooltip" title="Start nieuwe Minor versie (Maakt editor leeg)">
                            <span class="text-xs font-bold px-1">Minor++</span>
                        </button>
                    </div>

                    <div class="h-4 w-px bg-dark_border mx-1"></div>

                    <button onclick="window.createNewFile()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="Nieuw Bestand">
                        <i data-lucide="file-plus" width="18"></i>
                    </button>
                    <button onclick="window.pushToGitHub()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="GitHub Info">
                        <i data-lucide="github" width="18"></i>
                    </button>
                    <button onclick="window.copyCodeToClipboard()" class="p-2 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors" title="Kopieer">
                        <i data-lucide="copy" width="18"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 relative">
            <div id="editor"></div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-2xl text-white text-sm font-medium flex items-center gap-3 backdrop-blur-md border border-white/10 opacity-0 pointer-events-none transition-all duration-300 z-50 translate-y-2"></div>

    <div id="history-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-dark_paper border border-dark_border w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden fade-in flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-dark_border flex justify-between items-center bg-dark/50">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="history" width="20" class="text-primary"></i> Versie Geschiedenis
                    </h3>
                    <p id="history-modal-subtitle" class="text-xs text-slate-400 mt-0.5"></p>
                </div>
                <button onclick="document.getElementById('history-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i data-lucide="x" width="20"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 bg-dark" id="history-list-container">
                </div>
        </div>
    </div>

    <div id="github-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-dark_paper border border-dark_border w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in">
            <div class="p-4 border-b border-dark_border flex justify-between items-center bg-dark/30">
                <h3 class="text-lg font-bold text-white">GitHub Push Helper</h3>
                <button onclick="window.closeGitModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" width="20"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><p class="text-xs text-slate-500 font-bold">PROJECT</p><p id="git-project-name" class="text-slate-200"></p></div>
                    <div><p class="text-xs text-slate-500 font-bold">BESTAND</p><p id="git-file-name" class="text-slate-200"></p></div>
                    <div class="col-span-2"><p class="text-xs text-slate-500 font-bold">TARGET</p><p id="git-repo-url" class="text-blue-400 truncate"></p></div>
                </div>
                <div>
                    <p class="text-xs text-slate-500 font-bold mb-1">COMMIT MESSAGE</p>
                    <div class="flex gap-2"><input id="git-commit-message" readonly class="flex-1 bg-dark border border-dark_border rounded px-3 py-2 text-sm text-slate-300"><button id="git-copy-msg" class="p-2 bg-slate-700 rounded text-white"><i data-lucide="copy" width="14"></i></button></div>
                </div>
                <div>
                    <p class="text-xs text-slate-500 font-bold mb-1">CODE</p>
                    <div class="relative"><pre id="git-code-content" class="h-32 bg-dark border border-dark_border rounded p-3 text-xs text-slate-400 overflow-auto"></pre><button id="git-copy-code" class="absolute top-2 right-2 bg-primary text-white text-xs px-2 py-1 rounded">Kopieer</button></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const STORAGE_KEY_PROJECTS = 'code_projects_v8'; 
        const STORAGE_KEY_ACTIVE_PROJECT = 'active_project_id_v8';
        const STORAGE_KEY_ACTIVE_FILE = 'active_file_id_v8';

        let activeProjectId = localStorage.getItem(STORAGE_KEY_ACTIVE_PROJECT) || null;
        let activeFileId = localStorage.getItem(STORAGE_KEY_ACTIVE_FILE) || null;
        let expandedProjectId = activeProjectId; 
        
        let pendingVersionType = null; // 'major' or 'minor'
        let isEditing = false;
        let searchTerm = '';
        let editor;

        // --- CORE UTILS ---
        const generateId = () => Math.random().toString(36).substring(2, 9);
        const countLines = (code) => code.split('\n').length;
        const formatTime = (ts) => new Date(ts).toLocaleString('nl-NL', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' });
        
        function getAllProjects() { return JSON.parse(localStorage.getItem(STORAGE_KEY_PROJECTS) || '[]'); }
        function saveAllProjects(data) { localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(data)); }
        function getProjectById(id) { return getAllProjects().find(p => p.id === id); }
        function getFileById(pId, fId) { const p = getProjectById(pId); return p ? p.files.find(f => f.id === fId) : null; }

        // --- NEW WORKFLOW LOGIC ---

        // 1. Start proces: Editor leegmaken, klaar voor plakken
        window.initiateNewVersion = (type) => {
            if (!activeFileId) return showToast("Selecteer eerst een bestand.", 'error');
            
            // Bevestiging als er iets in staat
            if (editor.getValue().trim() !== '') {
                if(!confirm("De editor wordt leeggemaakt zodat je de nieuwe versie kunt plakken/typen. Doorgaan?")) return;
            }

            pendingVersionType = type;
            editor.setValue("", -1);
            editor.focus();

            // UI Update
            const typeLabel = type === 'major' ? 'MAJOR' : 'MINOR';
            document.getElementById('btn-save-pending').classList.remove('hidden');
            document.getElementById('btn-save-pending').innerHTML = `<i data-lucide="save" width="14"></i> OPSLAAN (${typeLabel})`;
            document.getElementById('action-group-normal').classList.add('opacity-50', 'pointer-events-none');
            
            lucide.createIcons();
            showToast(`Editor is leeg. Plak je nieuwe ${typeLabel} code en klik op OPSLAAN.`, 'info');
        };

        // 2. Opslaan knop geklikt: Versie berekenen en opslaan
        window.commitPendingVersion = () => {
            const content = editor.getValue();
            if(!content.trim()) return showToast("Kan geen lege versie opslaan.", 'error');

            const projects = getAllProjects();
            const p = projects.find(p => p.id === activeProjectId);
            const f = p?.files.find(f => f.id === activeFileId);
            if(!f) return;

            const latest = f.versions[0];
            let maj = 1, min = 0;
            if (latest) {
                maj = pendingVersionType === 'major' ? latest.major + 1 : latest.major;
                min = pendingVersionType === 'major' ? 0 : latest.minor + 1;
            }

            // Notitie (optioneel, vooral bij Major)
            let note = null;
            if (pendingVersionType === 'major') {
                note = prompt(`Notitie voor Versie ${maj}.${min}:`, "Nieuwe update");
                if(note === null) return; // Cancel
            }

            const newVersion = {
                id: generateId(),
                code: content,
                timestamp: Date.now(),
                major: maj, minor: min,
                name: `v${maj}.${min}`,
                note: note,
                isStable: pendingVersionType === 'major',
                lineCount: countLines(content)
            };

            f.versions.unshift(newVersion);
            saveAllProjects(projects);

            // Reset UI
            pendingVersionType = null;
            document.getElementById('btn-save-pending').classList.add('hidden');
            document.getElementById('action-group-normal').classList.remove('opacity-50', 'pointer-events-none');

            renderSidebar(projects);
            loadActiveFile(); // Update titel en UI
            showToast(`Versie ${newVersion.name} succesvol opgeslagen!`, 'success');
        };


        // --- EDITOR & UI ---
        function loadActiveFile() {
            const file = getFileById(activeProjectId, activeFileId);
            const project = getProjectById(activeProjectId);
            const titleEl = document.getElementById('editor-title-status');
            
            // Reset pending state if switching files
            pendingVersionType = null;
            document.getElementById('btn-save-pending').classList.add('hidden');
            document.getElementById('action-group-normal').classList.remove('opacity-50', 'pointer-events-none');

            if (file && project) {
                const ext = file.name.split('.').pop().toLowerCase();
                const modeMap = { js:'javascript', html:'html', css:'css', py:'python', json:'json' };
                editor.session.setMode(`ace/mode/${modeMap[ext] || 'text'}`);

                // Als er geen pending actie is, laad de laatste versie
                if (file.versions.length > 0) {
                    const latest = file.versions[0];
                    editor.setValue(latest.code, -1);
                    titleEl.innerHTML = `<span class="text-slate-400">${project.name} / </span><span class="text-white">${file.name}</span> <span class="ml-2 text-xs bg-dark_border px-1.5 py-0.5 rounded text-success">${latest.name}</span>`;
                } else {
                    editor.setValue("/* Nieuw bestand. Plak hier code en sla een versie op. */", -1);
                    titleEl.innerHTML = `<span class="text-slate-400">${project.name} / </span><span class="text-white">${file.name}</span>`;
                }
            } else {
                editor.setValue("/* Selecteer een project of maak een nieuwe aan. */", -1);
                titleEl.textContent = "Geen bestand geselecteerd";
            }
            renderSidebar(getAllProjects());
            lucide.createIcons();
        }

        // --- SIDEBAR ---
        function renderSidebar(projects) {
            const container = document.getElementById('sidebar-list');
            container.innerHTML = '';
            
            const filtered = projects.filter(p => p.name.toLowerCase().includes(searchTerm) || p.files.some(f => f.name.toLowerCase().includes(searchTerm)));

            if(filtered.length === 0) {
                container.innerHTML = `<li class="text-center text-xs text-slate-500 py-4">Geen resultaten</li>`;
                return;
            }

            filtered.forEach(p => {
                const isExpanded = p.id === expandedProjectId;
                const isActiveP = p.id === activeProjectId;

                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="flex items-center justify-between px-3 py-2 rounded-md cursor-pointer mb-1 transition-colors ${isActiveP ? 'bg-slate-800' : 'hover:bg-slate-800/50'}" onclick="window.toggleProject('${p.id}')">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i data-lucide="${isExpanded ? 'folder-open' : 'folder'}" class="${isActiveP ? 'text-primary' : 'text-slate-400'}" width="14"></i>
                            <span class="text-xs font-bold ${isActiveP ? 'text-white' : 'text-slate-300'} truncate">${p.name}</span>
                        </div>
                        ${isEditing ? 
                            `<button class="p-1 hover:text-red-400 text-slate-500" onclick="window.deleteProject(event, '${p.id}')"><i data-lucide="trash" width="12"></i></button>` : 
                            `<i data-lucide="chevron-down" class="text-slate-600 transition-transform ${isExpanded ? 'rotate-180' : ''}" width="12"></i>`
                        }
                    </div>
                `;

                if(isExpanded) {
                    const fileUl = document.createElement('ul');
                    fileUl.className = "pl-3 border-l border-dark_border ml-3 mb-2 space-y-0.5";
                    
                    if(p.files.length === 0) fileUl.innerHTML = `<li class="px-2 py-1 text-[10px] text-slate-500 italic">Geen bestanden</li>`;

                    p.files.forEach(f => {
                        const isActiveF = f.id === activeFileId && isActiveP;
                        const latestVer = f.versions.length > 0 ? f.versions[0].name : '-';
                        
                        const fLi = document.createElement('li');
                        fLi.className = `flex items-center justify-between group px-2 py-1.5 rounded cursor-pointer ${isActiveF ? 'bg-primary/20' : 'hover:bg-slate-800'}`;
                        fLi.onclick = () => window.setActiveItem(p.id, f.id);

                        fLi.innerHTML = `
                            <div class="flex items-center gap-2 truncate flex-1">
                                <i data-lucide="file-code" width="13" class="${isActiveF ? 'text-primary' : 'text-slate-500'}"></i>
                                <span class="text-xs ${isActiveF ? 'text-white font-medium' : 'text-slate-400'} truncate">${f.name}</span>
                                <span class="text-[10px] text-slate-500 bg-dark_border px-1 rounded ml-1">${latestVer}</span>
                            </div>
                            <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                ${isEditing ? 
                                    `<button class="p-1 hover:text-red-400 text-slate-500" onclick="window.deleteFile(event, '${p.id}', '${f.id}')"><i data-lucide="trash" width="12"></i></button>` :
                                    `<button class="p-1.5 hover:bg-slate-700 rounded text-slate-400 hover:text-white" title="Geschiedenis" onclick="window.openHistoryModal(event, '${p.id}', '${f.id}')">
                                        <i data-lucide="history" width="12"></i>
                                    </button>`
                                }
                            </div>
                        `;
                        fileUl.appendChild(fLi);
                    });
                    li.appendChild(fileUl);
                }
                container.appendChild(li);
            });
            lucide.createIcons();
        }

        // --- HISTORY MODAL ---
        window.openHistoryModal = (e, pId, fId) => {
            if(e) e.stopPropagation();
            const f = getFileById(pId, fId);
            const p = getProjectById(pId);
            if(!f) return;

            document.getElementById('history-modal-subtitle').textContent = `${p.name} / ${f.name}`;
            const listContainer = document.getElementById('history-list-container');
            listContainer.innerHTML = '';

            if(f.versions.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-slate-500 py-10">Geen geschiedenis beschikbaar.</div>`;
            } else {
                f.versions.forEach((v, index) => {
                    const item = document.createElement('div');
                    item.className = "flex items-start justify-between p-3 border-b border-dark_border hover:bg-slate-800/50 transition-colors group";
                    item.innerHTML = `
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono font-bold text-sm ${v.isStable ? 'text-green-400' : 'text-blue-400'}">${v.name}</span>
                                <span class="text-xs text-slate-500">${formatTime(v.timestamp)}</span>
                                ${index === 0 ? '<span class="text-[10px] bg-primary/20 text-primary px-1 rounded">Huidig</span>' : ''}
                            </div>
                            ${v.note ? `<p class="text-xs text-slate-400 mt-1 italic">"${v.note}"</p>` : ''}
                            <p class="text-[10px] text-slate-600 mt-1">${v.lineCount} regels</p>
                        </div>
                        <button onclick="window.loadVersionFromHistory('${pId}', '${fId}', '${v.id}')" class="px-3 py-1.5 bg-dark_border hover:bg-slate-600 text-slate-300 text-xs rounded transition-colors flex items-center gap-2">
                            <i data-lucide="rotate-ccw" width="12"></i> Laad Code
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            }

            document.getElementById('history-modal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.loadVersionFromHistory = (pId, fId, vId) => {
            const f = getFileById(pId, fId);
            const v = f.versions.find(ver => ver.id === vId);
            if(v) {
                window.setActiveItem(pId, fId); // Zorg dat het bestand actief wordt
                editor.setValue(v.code, -1);
                document.getElementById('history-modal').classList.add('hidden');
                
                // Update titel om aan te geven dat we een oude versie kijken
                const titleEl = document.getElementById('editor-title-status');
                titleEl.innerHTML += ` <span class="ml-2 text-xs bg-yellow-500/20 text-yellow-500 px-1.5 py-0.5 rounded border border-yellow-500/30">Geladen: ${v.name}</span>`;
                
                showToast(`Versie ${v.name} in editor geladen.`, 'info');
            }
        };

        // --- GLOBAL ACTIONS ---
        window.saveNewProject = () => {
            const content = editor.getValue();
            if(!content.trim()) return showToast("Editor is leeg.", 'error');
            const name = prompt("Projectnaam:"); if(!name) return;
            const fileName = prompt("Bestandsnaam (bv: index.js):", "index.js"); if(!fileName) return;

            const pId = generateId(); const fId = generateId();
            const newVer = { id: generateId(), code: content, timestamp: Date.now(), major: 1, minor: 0, name: "v1.0", note: "Start", isStable: true, lineCount: countLines(content) };
            
            const projects = getAllProjects();
            projects.unshift({ id: pId, name: name, files: [{ id: fId, name: fileName, versions: [newVer] }] });
            saveAllProjects(projects);
            window.setActiveItem(pId, fId);
            showToast("Project aangemaakt!", 'success');
        };

        window.createNewFile = () => {
            if(!activeProjectId) return showToast("Geen project geselecteerd", 'error');
            const name = prompt("Bestandsnaam:"); if(!name) return;
            const projects = getAllProjects();
            projects.find(p => p.id === activeProjectId).files.push({ id: generateId(), name: name, versions: [] });
            saveAllProjects(projects);
            renderSidebar(projects);
            showToast("Bestand aangemaakt", 'success');
        };

        window.setActiveItem = (pId, fId) => {
            activeProjectId = pId; activeFileId = fId;
            localStorage.setItem(STORAGE_KEY_ACTIVE_PROJECT, pId);
            localStorage.setItem(STORAGE_KEY_ACTIVE_FILE, fId);
            loadActiveFile();
        };

        window.toggleProject = (id) => { expandedProjectId = expandedProjectId === id ? null : id; renderSidebar(getAllProjects()); };
        window.toggleEditMode = () => { isEditing = !isEditing; document.getElementById('edit-mode-btn').classList.toggle('bg-primary'); renderSidebar(getAllProjects()); };
        
        window.deleteProject = (e, id) => { 
            e.stopPropagation(); 
            if(confirm("Project verwijderen?")) { 
                saveAllProjects(getAllProjects().filter(p => p.id !== id)); 
                if(activeProjectId === id) { activeProjectId=null; loadActiveFile(); } 
                else renderSidebar(getAllProjects()); 
            } 
        };
        window.deleteFile = (e, pId, fId) => {
            e.stopPropagation();
            if(confirm("Bestand verwijderen?")) {
                const all = getAllProjects();
                const p = all.find(p => p.id === pId);
                p.files = p.files.filter(f => f.id !== fId);
                saveAllProjects(all);
                if(activeFileId === fId) { activeFileId=null; loadActiveFile(); }
                else renderSidebar(all);
            }
        };

        window.copyCodeToClipboard = () => { navigator.clipboard.writeText(editor.getValue()); showToast("Gekopieerd", 'success'); };
        
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed bottom-6 right-6 px-4 py-3 rounded-xl shadow-2xl text-white text-sm font-medium transition-all duration-300 z-50 ${type==='error'?'bg-danger':(type==='success'?'bg-success':'bg-primary')}`;
            t.style.opacity = '1'; t.style.transform = 'translateY(0)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; }, 3000);
        }

        // --- GITHUB MOCKUP ---
        window.pushToGitHub = () => {
            if (!activeFileId) return showToast("Geen bestand", 'error');
            document.getElementById('github-modal').classList.remove('hidden');
            const f = getFileById(activeProjectId, activeFileId);
            document.getElementById('git-file-name').textContent = f.name;
            document.getElementById('git-code-content').textContent = editor.getValue();
            document.getElementById('git-copy-code').onclick = () => { navigator.clipboard.writeText(editor.getValue()); showToast("Code gekopieerd", 'success'); }
        };
        window.closeGitModal = () => document.getElementById('github-modal').classList.add('hidden');

        // Export/Import
        window.exportData = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(getAllProjects(),null,2)], {type:'application/json'}));
            a.download = 'backup.json'; a.click();
        };
        window.triggerImport = () => document.getElementById('importFile').click();
        document.getElementById('importFile').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => { saveAllProjects(JSON.parse(ev.target.result)); loadActiveFile(); };
            r.readAsText(e.target.files[0]);
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night_eighties");
            editor.setOptions({ fontSize: "14px", showPrintMargin: false });
            
            loadActiveFile();
            document.getElementById('search-input').addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); renderSidebar(getAllProjects()); });
        });
    </script>
</body>
</html>
